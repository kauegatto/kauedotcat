<!doctype html><html lang=pt dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>RabbitMQ com Java e Spring : Entendendo de verdade e com um toque de elegância (parte 2) | Kaue Gatto</title><meta name=keywords content="SPRING,JAVA,RABBITMQ"><meta name=description content="RabbitMQ é uma das principais soluções para envio de mensagens assíncronas na indústria, vamos entender o que é o protocolo AMQP e começar a implementar essa ferramenta com muitos exemplos em JAVA"><meta name=author content="Me"><link rel=canonical href=https://canonical.url/to/page><meta name=google-site-verification content="XYZabc"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.5cfc680b1eeaeef9efbced92d46c2a9e876b72ee14fba85846afc4cff9e6e6f8.css integrity="sha256-XPxoCx7q7vnvvO2S1Gwqnodrcu4U+6hYRq/Ez/nm5vg=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://kaue.cat/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=16x16 href=https://kaue.cat/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=32x32 href=https://kaue.cat/%3Clink%20/%20abs%20url%3E><link rel=apple-touch-icon href=https://kaue.cat/%3Clink%20/%20abs%20url%3E><link rel=mask-icon href=https://kaue.cat/%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=pt href=https://kaue.cat/posts/java_rabbitmq_parte2/><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-6MZTJBEG75"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-6MZTJBEG75",{anonymize_ip:!1})}</script><script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","G-6MZTJBEG75","auto"),ga("send","pageview"))</script><script async src=https://www.google-analytics.com/analytics.js></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-6MZTJBEG75"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-6MZTJBEG75",{anonymize_ip:!1})}</script><meta property="og:title" content="RabbitMQ com Java e Spring : Entendendo de verdade e com um toque de elegância (parte 2)"><meta property="og:description" content="RabbitMQ é uma das principais soluções para envio de mensagens assíncronas na indústria, vamos entender o que é o protocolo AMQP e começar a implementar essa ferramenta com muitos exemplos em JAVA"><meta property="og:type" content="article"><meta property="og:url" content="https://kaue.cat/posts/java_rabbitmq_parte2/"><meta property="og:image" content="https://kaue.cat/%3Cimage%20path/url%3E"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-11-12T19:30:03+00:00"><meta property="article:modified_time" content="2023-11-12T19:30:03+00:00"><meta property="og:site_name" content="Kaue Gatto"><meta property="og:see_also" content="https://kaue.cat/posts/java_rabbitmq_parte1/"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://kaue.cat/%3Cimage%20path/url%3E"><meta name=twitter:title content="RabbitMQ com Java e Spring : Entendendo de verdade e com um toque de elegância (parte 2)"><meta name=twitter:description content="RabbitMQ é uma das principais soluções para envio de mensagens assíncronas na indústria, vamos entender o que é o protocolo AMQP e começar a implementar essa ferramenta com muitos exemplos em JAVA"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://kaue.cat/posts/"},{"@type":"ListItem","position":3,"name":"RabbitMQ com Java e Spring : Entendendo de verdade e com um toque de elegância (parte 2)","item":"https://kaue.cat/posts/java_rabbitmq_parte2/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"RabbitMQ com Java e Spring : Entendendo de verdade e com um toque de elegância (parte 2)","name":"RabbitMQ com Java e Spring : Entendendo de verdade e com um toque de elegância (parte 2)","description":"RabbitMQ é uma das principais soluções para envio de mensagens assíncronas na indústria, vamos entender o que é o protocolo AMQP e começar a implementar essa ferramenta com muitos exemplos em JAVA","keywords":["SPRING","JAVA","RABBITMQ"],"articleBody":"Texto necessita outra revisão.\nAprofundando Nota: Nesse momento, entraremos um pouco mais em detalhes sobre como o protocolo AMQP funciona, escrevi um “guia” bem básico sobre propriedades do protocolo, se quiser conferir, pode ver aqui :)\nmensageria.pdf\nOu nesse link\nContexto O Spring AMQP consiste em dois módulos principais: spring-amqp e spring-rabbit. O ‘spring-amqp’ contém o pacote org.springframework.amqp.core, que trata das principais abstrações definidas no protocolo AMQP (RabbitMQ é um broker, que implementa esse protocolo), esse pacote não se baseia em nenhuma biblioteca de clientes nem implementação de broker.\nEssas abstrações então são implementadas pelos módulos específicos dos brokers (spring-rabbit). Teoricamente, como o AMQP é opera em nível de protocolo, você poderia utilizar o cliente do rabbit com outro broker, mas isso não é oficialmente suportado.\nA mensagem A mensagem ****definida no protocolo amqp é um conjunto de bytes e propriedades, passados separadamente. Para tornar o uso mais fácil, dentro do java juntamos isso em uma abstração chamada Message\npublic class Message { private final MessageProperties messageProperties; private final byte[] body; public Message(byte[] body, MessageProperties messageProperties) { this.body = body; this.messageProperties = messageProperties; } public byte[] getBody() { return this.body; } public MessageProperties getMessageProperties() { return this.messageProperties; } } A exchange A exchange é uma outra abstração simples, é basicamente o centro de distribuição de mensagens, que envia as mensagens de acordo com suas diretrizes:\npublic interface Exchange { String getName(); String getExchangeType(); boolean isDurable(); boolean isAutoDelete(); Map\u003cString, Object\u003e getArguments(); } Os tipos básicos de exchange são: direct, topic, fanout e headers. Você pode encontrar implementações para cada um dos tipos no pacote core.\nA Topic exchange supports bindings with routing patterns that may include the ‘*’ and ‘#’ wildcards for ’exactly-one’ and ‘zero-or-more’, respectively. The Fanout exchange publishes to all queues that are bound to it without taking any routing key into consideration.\nQueues A classe Queue também representa uma abstração desse tipo no protocolo:\npublic class Queue { private final String name; private volatile boolean durable; private volatile boolean exclusive; private volatile boolean autoDelete; private volatile Map\u003cString, Object\u003e arguments; /** * The queue is durable, non-exclusive and non auto-delete. * * @param name the name of the queue. */ public Queue(String name) { this(name, true, false, false); } // Getters e Setters omitidos } Bindings Bindings são a relação entre filas e exchanges!\nnew Binding(someQueue, someDirectExchange, \"foo.bar\"); // direct exchange, routing keys fixas new Binding(someQueue, someTopicExchange, \"foo.*\"); // topic exchange, usando wildcard new Binding(someQueue, someFanoutExchange); // fanout Binding b = BindingBuilder.bind(someQueue).to(someTopicExchange).with(\"foo.*\"); // BindingBuilder é a maneira bonitinha, eu gosto, mas importa estático! Definindo Exchanges e Bindings customizadas Já vimos nos exemplos anteriores como as exchanges, bindings e queues são criadas, a partir de agora, só criar!\nNossas configurações, ao invés de só possuir bean de Queue, agora incluirão Exchangese Bindings\n@Configuration @Slf4j @RequiredArgsConstructor public class RabbitMqConfiguration { private final TicketQueueProperties ticketQueueProperties; @Bean public Queue queue(){ log.info(\"Looking for queue: {}\", ticketQueueProperties.getName()); return new Queue(ticketQueueProperties.getName(), true); } @Bean Exchange ticketDirectExchange(){ final String EXCHANGE_NAME = \"ticket\"; log.info(\"Creating exchange: ticket-exchange\"); return new DirectExchange(EXCHANGE_NAME); } @Bean Binding ticketBinding(){ log.info(\"Create ticket binding\"); return BindingBuilder.bind(queue()).to(ticketDirectExchange()).with(ticketQueueProperties.getName()).noargs(); } } Perfeito, já vimos nossa exchange funcionando bonito! Tudo pronto!\nSó que não! Lembre-se que o nosso publisher está enviando mensagens com a routing key correta, mas para a exchange errada, vamos mudar o código para o seguinte:\nrabbitTemplate.convertAndSend(\"direct.ticket\",ticketQueueProperties.getName(),event.name()); Aqui deveríamos puxar esse nome da nossa ideal TicketQueueProperties :) para evitar esse spaghetti Passando Objetos - Message Converters O AmqpTemplate também define vários métodos para enviar e receber mensagens que, no fim das contas, delegam tarefas para um MessageConverter. O MessageConverter fornece um método único para cada direção: um para converter para um Message e outro para converter a partir de um Message.\nDefinição da interface MessageConverter:\npublic interface MessageConverter { Message toMessage(Object object, MessageProperties messageProperties) throws MessageConversionException; Object fromMessage(Message message) throws MessageConversionException; } SimpleMessageConverter A implementação padrão do strategy MessageConverter é chamada de SimpleMessageConverter. Este é o conversor usado por uma instância de RabbitTemplate se você não configurar explicitamente uma alternativa.\nConverts a String to a [TextMessage](https://jakarta.ee/specifications/platform/9/apidocs/jakarta/jms/TextMessage.html), a byte array to a [BytesMessage](https://jakarta.ee/specifications/platform/9/apidocs/jakarta/jms/BytesMessage.html), a Map to a [MapMessage](https://jakarta.ee/specifications/platform/9/apidocs/jakarta/jms/MapMessage.html), and a Serializable object to a [ObjectMessage](https://jakarta.ee/specifications/platform/9/apidocs/jakarta/jms/ObjectMessage.html) (or vice versa).\nTrocando o Conversor Para trabalhar com objetos serializados e desserializados para JSON, vamos usar o Jackson2JsonMessageConverter.\n@Bean public MessageConverter messageConverter() { return new Jackson2JsonMessageConverter(); } Colocaremos isso tanto no consumer quanto no producer :)\nDeclarables, Definição Dinâmica e Declarativa de Filas Falamos anteriormente do nossoTicketQueueProperties , que poderíamos melhorá-lo, é o que vamos fazer, na realidade, vamos substituí-lo.\nPrimeiro de tudo, vamos definir um formato declarativo para filas, exchanges e bindings que nos agrade, para mim:\nbroker: queues: ticket: name: default.ticket exchanges: ticket: name: direct.ticket type: direct bindings: ticket: exchange: direct.ticket queue: default.ticket routingKey: default.ticket Criando um ConfigurationProperties adequado A partir disso, vamos mapear essas propriedades em classes de uma maneira adequada. Chamarei a classe de BrokerConfigurationProperties:\npackage com.kaue.ticketservice.infrastructure.properties; import jakarta.validation.constraints.NotEmpty; import org.springframework.boot.context.properties.ConfigurationProperties; import org.springframework.context.annotation.Configuration; import java.util.Map; import lombok.Data; @Configuration @ConfigurationProperties(prefix = \"broker\") @Data public class BrokerConfigurationProperties { private Map\u003cString, QueueProperties\u003e queues; private Map\u003cString, ExchangeProperties\u003e exchanges; private Map\u003cString, BindingProperties\u003e bindings; @Data public static class QueueProperties { @NotEmpty private String name; } @Data public static class ExchangeProperties { @NotEmpty private String name; private String type; } @Data public static class BindingProperties { @NotEmpty private String exchange; @NotEmpty private String queue; @NotEmpty private String routingKey; } } Possuímos 3 maps, estruturas que linkam uma chave à sua correspondente configuração, Queue, Exchange ou Binding Properties. Fazemos o mapeamento padrão, usando : @ConfigurationProperties(prefix = \"broker\"), até aqui, sem segredos 🙂 Transformando as propriedades em objetos! A partir de agora, o terceiro passo pode parecer simples, devemos criar beans a partir das propriedades, isso não é um problema, pelo menos não se quisermos definir os Beans da maneira que fizemos antes, apesar disso, se quisermos definir uma lista de Queues, Exchanges e Bindings, devemos usar a classe Declarables, e prover um bean para ela.\nDeclarables: “…Used to declare multiple objects on the broker using a single bean declaration for the collection.”\n@Bean public Declarables es() { return new Declarables( new DirectExchange(\"e2\", false, true), new DirectExchange(\"e3\", false, true)); } @Bean public Declarables qs() { return new Declarables( new Queue(\"q2\", false, false, true), new Queue(\"q3\", false, false, true)); } @Bean public Declarables bs() { return new Declarables( new Binding(\"q2\", DestinationType.QUEUE, \"e2\", \"k2\", null), new Binding(\"q3\", DestinationType.QUEUE, \"e3\", \"k3\", null)); } O exemplo acima, da documentação de referência do spring, é uma boa forma de exemplificar o uso mais simples de Declarables, vamos ver minha implementação em particular, que adiciona declarables de acordo com a BrokerConfigurationProperties\npackage com.kaue.ticketservice.infrastructure.configuration; // ... ommitted /** * This classes creates all queues, exchanges and bindings based on application.yaml when they're needed (called by a consumer or posted a message into). */ @Configuration @Slf4j @RequiredArgsConstructor public class RabbitMqConfiguration { private final BrokerConfigurationProperties brokerConfig; private final List\u003cQueue\u003e definedQueues = new ArrayList\u003c\u003e(); private final List\u003cExchange\u003e definedExchanges = new ArrayList\u003c\u003e(); @Bean public Declarables queues() { if (brokerConfig == null || brokerConfig.getQueues() == null) { return new Declarables(); // Return an empty list if no queues are configured } var queueList = brokerConfig.getQueues().values().stream() .filter(Objects::nonNull) .map(queueProperties -\u003e new Queue(queueProperties.getName(), true)) .toList(); definedQueues.addAll(queueList); log.info(\"Declared queues\"); return new Declarables(queueList); } @Bean public Declarables exchanges() { if (brokerConfig == null || brokerConfig.getExchanges() == null) { return new Declarables(); // Return an empty list if no exchanges are configured } var exchangesList = brokerConfig.getExchanges().values().stream() .filter(Objects::nonNull) .map(exchangeProperties -\u003e new DirectExchange(exchangeProperties.getName())) // todo use correct exchange type .toList(); definedExchanges.addAll(exchangesList); log.info(\"Declared exchanges\"); return new Declarables(exchangesList); } @Bean public Declarables bindings() { if (brokerConfig == null || brokerConfig.getBindings() == null) { return new Declarables(); } var bindingsList = brokerConfig.getBindings().values().stream() .map(bindingProperties -\u003e { log.info(\"Creating binding between exchange {} and queue {} with routing key {}\", bindingProperties.getExchange(), bindingProperties.getQueue(), bindingProperties.getRoutingKey()); Queue queue = findQueueByName(bindingProperties.getQueue()); Exchange exchange = findExchangeByName(bindingProperties.getExchange()); return BindingBuilder.bind(queue) .to(exchange) .with(bindingProperties.getRoutingKey()) .noargs(); }) .toList(); return new Declarables(bindingsList); } private Queue findQueueByName (String queueName){ return definedQueues.stream() .filter(queue -\u003e queueName.equals(queue.getName())) .findFirst() .orElse(null); } private Exchange findExchangeByName (String exchangeName){ return definedExchanges.stream() .filter(exchange -\u003e exchangeName.equals(exchange.getName())) .findFirst() .orElse(null); } } Embora grande, a implementação é relativamente simples, usamos streams para transformar as propriedades em classes reais e retornamos o Declarable como um Bean, um objeto gerenciado pelo spring.\nPoderes de RabbitListener No Spring, quando um método anotado como listener joga uma exception, as mensagens podem ser inseridas novamente na fila e reprocessadas, descartadas ou colocadas em uma Dead Letter Queue. Nada é devolvido ao emissor da mensagem.\nError Handling Na versão 2.0 do Spring AMQP em diante, @RabbitLisetener tem 2 atributos: errorHandler ereturnExceptions, mas eles não são configurados por padrão.\nVocê pode usar o errorHandler para prover um Bean de RabbitListenerErrorHandler. Essa interface funcional tem um método:\n@FunctionalInterface public interface RabbitListenerErrorHandler { Object handleError(Message amqpMessage, org.springframework.messaging.Message\u003c?\u003e message, ListenerExecutionFailedException exception) throws Exception; } Aqui, por exemplo, poderíamos dizer que exceções de serviço ou fatais jogam exceções AmqpRejectAndDontRequeueException, para evitar requeue.\nAs you can see, you have access to the raw message received from the container, the spring-messaging Message\u003c?\u003e object produced by the message converter, and the exception that was thrown by the listener (wrapped in a ListenerExecutionFailedException). The error handler can either return some result (which is sent as the reply) or throw the original or a new exception (which is thrown to the container or returned to the sender, depending on the returnExceptions setting).\nA citação acima comenta uma maneira de enviar exceptions de volta ao sender, se te interessar, pode ver aqui\nRetries! Podemos customizar e modificar configurações de retry indicadas dentro do nosso projeto, para isso usaremos o projeto spring-retry, vamos ver uma configuração simples no Bean do RabbitTemplate:\n@Bean public RabbitTemplate rabbitTemplate() { RabbitTemplate template = new RabbitTemplate(connectionFactory()); RetryTemplate retryTemplate = RetryTemplate.builder() .maxAttempts(3) .fixedBackoff(1000) .retryOn(RemoteAccessException.class) .build(); retryTemplate.execute(ctx -\u003e { // ... do something }); template.setRetryTemplate(retryTemplate); return template; } Para mais informações, veja o [spring-retry](https://github.com/spring-projects/spring-retry#using-retrytemplate)\nDead Letters When a listener throws an exception, it is wrapped in a ListenerExecutionFailedException. Normally the message is rejected and requeued by the broker. Setting defaultRequeueRejected to false causes messages to be discarded (or routed to a dead letter exchange).\nVamos tentar seguir o que o comentário acima da documentação do spring diz:\nspring: rabbitmq : ... adresses e outras configs listener: simple: default-requeue-rejected: false Depois dessa configuração, as mensagens quando possuem um erro são DELETADAS, desabilitando os retries. Isso provavelmente não é o que queremos, por isso, vamos estudar as DLQ’s.\nDead Letter Queues (DLQ) são filas que possuem mensagens que tiveram sua execução falhada em algum momento, o comportamento das DLQ’s pode ser configurado no próprio broker.\nDead Letter Queues são úteis em sistemas mais críticos, onde necessitamos que um job rode de qualquer forma, onde podemos jogar mensagens de DLQ’s na exchange padrão novamente, ou pelo menos entendermos o porquê daquilo não ter sido executado, essas filas possuem diversas funções.\nA maneira de definir dead letters é algo explicado dentro do protocolo AMQP, podemos apenas seguir essa configuração:\n@Bean Queue messagesQueue() { return QueueBuilder.durable(\"queue-name\") .withArgument(\"x-dead-letter-exchange\", \"nome-exchange.dlx\") .withArgument(\"x-dead-letter-routing-key\", \"queue-name.dlq\") // nao precisa ser o nome da queue, mas é comum para direct .build(); } @Bean Queue deadLetterQueue() { return QueueBuilder.durable(\"queue-name.dlq\").build(); } No fim das contas, uma dead letter queue é uma queue normal, e uma dead letter exchange também, portanto, se uma mensagem chegar na DLX (Dead Letter Exchange) e não tiver uma routing key correta, ela não chegará na fila, tudo normal por aqui.\nObservações Existem diversas maneiras de trabalhar com rabbitMQ, e uma infinidade de propriedades e configurações não mostradas aqui, como por exemplo: Feedback síncrono de exchanges e filas, Consumers Assíncronos, Containers Diferentes, propriedades de requeue, monitoramento de consumers, etc. Se algo fizer sentido para seu contexto, pode buscar no material de referência do Spring 🙂\nMais sobre DLQ: https://www.youtube.com/watch?v=GgIJWxk_-jM\nMais sobre exception handling: https://www.baeldung.com/spring-amqp-error-handling\nReferências https://docs.spring.io/spring-amqp/reference/html/#template-retry\nhttps://github.com/spring-projects/spring-retry\nhttps://www.baeldung.com/spring-amqp-error-handling\n","wordCount":"1948","inLanguage":"pt","image":"https://kaue.cat/%3Cimage%20path/url%3E","datePublished":"2023-11-12T19:30:03Z","dateModified":"2023-11-12T19:30:03Z","author":{"@type":"Person","name":"Me"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://kaue.cat/posts/java_rabbitmq_parte2/"},"publisher":{"@type":"Organization","name":"Kaue Gatto","logo":{"@type":"ImageObject","url":"https://kaue.cat/%3Clink%20/%20abs%20url%3E"}}}</script></head><body class=dark id=top><script>localStorage.getItem("pref-theme")==="light"&&document.body.classList.remove("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://kaue.cat accesskey=h title="Home (Alt + H)"><img src=https://kaue.cat/apple-touch-icon.png alt aria-label=logo height=35>Home</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li>|</li><li><a href=https://kaue.cat/en/ title=English aria-label=English>En</a></li></ul></div></div><ul id=menu><li><a href=https://kaue.cat/archives title=Arquivo><span>Arquivo</span></a></li><li><a href=https://kaue.cat/search/ title=Buscar><span>Buscar</span></a></li><li><a href=https://kaue.cat/series/ title=Séries><span>Séries</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://kaue.cat>Início</a>&nbsp;»&nbsp;<a href=https://kaue.cat/posts/>Posts</a></div><h1 class=post-title>RabbitMQ com Java e Spring : Entendendo de verdade e com um toque de elegância (parte 2)</h1><div class=post-description>RabbitMQ é uma das principais soluções para envio de mensagens assíncronas na indústria, vamos entender o que é o protocolo AMQP e começar a implementar essa ferramenta com muitos exemplos em JAVA</div><div class=post-meta><span title='2023-11-12 19:30:03 +0000 UTC'>novembro 12, 2023</span>&nbsp;·&nbsp;10 minutos&nbsp;·&nbsp;1948 palavras&nbsp;·&nbsp;Me&nbsp;|&nbsp;<a href=https://github.com/kauegatto/kauedotcat/content/posts/java_rabbitmq_parte2.md rel="noopener noreferrer" target=_blank>Sugerir Alterações</a></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Conteúdo</span></summary><div class=inner><nav id=TableOfContents><ul><li><ul><li><a href=#nota>Nota:</a></li></ul></li><li><a href=#contexto>Contexto</a></li><li><a href=#a-mensagem>A mensagem</a></li><li><a href=#a-exchange>A exchange</a></li><li><a href=#queues>Queues</a></li><li><a href=#bindings>Bindings</a></li></ul><ul><li><a href=#simplemessageconverter>SimpleMessageConverter</a></li><li><a href=#trocando-o-conversor>Trocando o Conversor</a></li></ul><ul><li><a href=#criando-um-configurationproperties-adequado>Criando um ConfigurationProperties adequado</a></li><li><a href=#transformando-as-propriedades-em-objetos>Transformando as propriedades em objetos!</a></li></ul><ul><li><a href=#error-handling>Error Handling</a></li><li><a href=#retries>Retries!</a></li></ul></nav></div></details></div><div class=post-content><p>Texto necessita outra revisão.</p><h1 id=aprofundando>Aprofundando<a hidden class=anchor aria-hidden=true href=#aprofundando>#</a></h1><h3 id=nota>Nota:<a hidden class=anchor aria-hidden=true href=#nota>#</a></h3><p>Nesse momento, entraremos um pouco mais em detalhes sobre como o protocolo AMQP funciona, escrevi um “guia” bem básico sobre propriedades do protocolo, se quiser conferir, pode ver aqui :)</p><p><a href=https://prod-files-secure.s3.us-west-2.amazonaws.com/f9f3aa45-f67b-42fb-a9fd-ab2167038212/299d79c0-36e3-442a-a6bf-3cdf3d4e5a1a/mensageria.pdf>mensageria.pdf</a></p><p>Ou <a href="https://drive.google.com/drive/folders/1PcESYtUyQ6O9QZun67YhjYXFjJSoCLZq?usp=sharing">nesse link</a></p><h2 id=contexto>Contexto<a hidden class=anchor aria-hidden=true href=#contexto>#</a></h2><p>O <code>Spring AMQP</code> consiste em dois módulos principais: <code>spring-amqp</code> e <code>spring-rabbit</code>. O ‘spring-amqp’ contém o pacote <code>org.springframework.amqp.core</code>, que trata das principais abstrações definidas no protocolo AMQP (RabbitMQ é um broker, que implementa esse protocolo), esse pacote não se baseia em nenhuma biblioteca de clientes nem implementação de broker.</p><p>Essas abstrações então são implementadas pelos módulos específicos dos brokers (<code>spring-rabbit</code>). <a href=https://docs.spring.io/spring-amqp/reference/html/#amqp-abstractions>Teoricamente, como o AMQP é opera em nível de protocolo, você poderia utilizar o cliente do rabbit com outro broker, mas isso não é oficialmente suportado</a>.</p><h2 id=a-mensagem>A mensagem<a hidden class=anchor aria-hidden=true href=#a-mensagem>#</a></h2><p>A mensagem ****definida no protocolo amqp é um conjunto de bytes e propriedades, passados separadamente. Para tornar o uso mais fácil, dentro do java juntamos isso em uma abstração chamada <code>Message</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>Message</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>final</span> <span class=n>MessageProperties</span> <span class=n>messageProperties</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>final</span> <span class=kt>byte</span><span class=o>[]</span> <span class=n>body</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=nf>Message</span><span class=o>(</span><span class=kt>byte</span><span class=o>[]</span> <span class=n>body</span><span class=o>,</span> <span class=n>MessageProperties</span> <span class=n>messageProperties</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=o>.</span><span class=na>body</span> <span class=o>=</span> <span class=n>body</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=o>.</span><span class=na>messageProperties</span> <span class=o>=</span> <span class=n>messageProperties</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>byte</span><span class=o>[]</span> <span class=nf>getBody</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=k>this</span><span class=o>.</span><span class=na>body</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=n>MessageProperties</span> <span class=nf>getMessageProperties</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=k>this</span><span class=o>.</span><span class=na>messageProperties</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><h2 id=a-exchange>A exchange<a hidden class=anchor aria-hidden=true href=#a-exchange>#</a></h2><p>A exchange é uma outra abstração simples, é basicamente o centro de distribuição de mensagens, que envia as mensagens de acordo com suas diretrizes:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>interface</span> <span class=nc>Exchange</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>String</span> <span class=nf>getName</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>String</span> <span class=nf>getExchangeType</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=kt>boolean</span> <span class=nf>isDurable</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=kt>boolean</span> <span class=nf>isAutoDelete</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=o>,</span> <span class=n>Object</span><span class=o>&gt;</span> <span class=nf>getArguments</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>Os tipos básicos de exchange são: <code>direct</code>, <code>topic</code>, <code>fanout</code> e <code>headers</code>. Você pode encontrar implementações para cada um dos tipos no pacote core.</p><blockquote><p>A <code>Topic</code> exchange supports bindings with routing patterns that may include the &lsquo;*&rsquo; and &lsquo;#&rsquo; wildcards for &rsquo;exactly-one&rsquo; and &lsquo;zero-or-more&rsquo;, respectively. The <code>Fanout</code> exchange publishes to all queues that are bound to it without taking any routing key into consideration.</p></blockquote><h2 id=queues>Queues<a hidden class=anchor aria-hidden=true href=#queues>#</a></h2><p>A classe <code>Queue</code> também representa uma abstração desse tipo no protocolo:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>Queue</span>  <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>final</span> <span class=n>String</span> <span class=n>name</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>volatile</span> <span class=kt>boolean</span> <span class=n>durable</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>volatile</span> <span class=kt>boolean</span> <span class=n>exclusive</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>volatile</span> <span class=kt>boolean</span> <span class=n>autoDelete</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>volatile</span> <span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=o>,</span> <span class=n>Object</span><span class=o>&gt;</span> <span class=n>arguments</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * The queue is durable, non-exclusive and non auto-delete.
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * @param name the name of the queue.
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=nf>Queue</span><span class=o>(</span><span class=n>String</span> <span class=n>name</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=o>(</span><span class=n>name</span><span class=o>,</span> <span class=kc>true</span><span class=o>,</span> <span class=kc>false</span><span class=o>,</span> <span class=kc>false</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Getters e Setters omitidos
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>}</span>
</span></span></code></pre></div><h2 id=bindings>Bindings<a hidden class=anchor aria-hidden=true href=#bindings>#</a></h2><p>Bindings são a relação entre filas e exchanges!</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=k>new</span> <span class=n>Binding</span><span class=o>(</span><span class=n>someQueue</span><span class=o>,</span> <span class=n>someDirectExchange</span><span class=o>,</span> <span class=s>&#34;foo.bar&#34;</span><span class=o>);</span> <span class=c1>// direct exchange, routing keys fixas
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>new</span> <span class=n>Binding</span><span class=o>(</span><span class=n>someQueue</span><span class=o>,</span> <span class=n>someTopicExchange</span><span class=o>,</span> <span class=s>&#34;foo.*&#34;</span><span class=o>);</span> <span class=c1>// topic exchange, usando wildcard
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>new</span> <span class=n>Binding</span><span class=o>(</span><span class=n>someQueue</span><span class=o>,</span> <span class=n>someFanoutExchange</span><span class=o>);</span> <span class=c1>// fanout
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>Binding</span> <span class=n>b</span> <span class=o>=</span> <span class=n>BindingBuilder</span><span class=o>.</span><span class=na>bind</span><span class=o>(</span><span class=n>someQueue</span><span class=o>).</span><span class=na>to</span><span class=o>(</span><span class=n>someTopicExchange</span><span class=o>).</span><span class=na>with</span><span class=o>(</span><span class=s>&#34;foo.*&#34;</span><span class=o>);</span> 
</span></span><span class=line><span class=cl><span class=c1>// BindingBuilder é a maneira bonitinha, eu gosto, mas importa estático!
</span></span></span></code></pre></div><h1 id=definindo-exchanges-e-bindings-customizadas>Definindo Exchanges e Bindings customizadas<a hidden class=anchor aria-hidden=true href=#definindo-exchanges-e-bindings-customizadas>#</a></h1><p>Já vimos nos exemplos anteriores como as exchanges, bindings e queues são criadas, a partir de agora, só criar!</p><p>Nossas configurações, ao invés de só possuir bean de <code>Queue</code>, agora incluirão <code>Exchanges</code>e <code>Bindings</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Configuration</span>
</span></span><span class=line><span class=cl><span class=nd>@Slf4j</span>
</span></span><span class=line><span class=cl><span class=nd>@RequiredArgsConstructor</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>RabbitMqConfiguration</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kd>final</span> <span class=n>TicketQueueProperties</span> <span class=n>ticketQueueProperties</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Bean</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=n>Queue</span> <span class=nf>queue</span><span class=o>(){</span>
</span></span><span class=line><span class=cl>    <span class=n>log</span><span class=o>.</span><span class=na>info</span><span class=o>(</span><span class=s>&#34;Looking for queue: {}&#34;</span><span class=o>,</span> <span class=n>ticketQueueProperties</span><span class=o>.</span><span class=na>getName</span><span class=o>());</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=k>new</span> <span class=n>Queue</span><span class=o>(</span><span class=n>ticketQueueProperties</span><span class=o>.</span><span class=na>getName</span><span class=o>(),</span> <span class=kc>true</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=nd>@Bean</span> <span class=n>Exchange</span> <span class=nf>ticketDirectExchange</span><span class=o>(){</span>
</span></span><span class=line><span class=cl>    <span class=kd>final</span> <span class=n>String</span> <span class=n>EXCHANGE_NAME</span> <span class=o>=</span> <span class=s>&#34;ticket&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=n>log</span><span class=o>.</span><span class=na>info</span><span class=o>(</span><span class=s>&#34;Creating exchange: ticket-exchange&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=k>new</span> <span class=n>DirectExchange</span><span class=o>(</span><span class=n>EXCHANGE_NAME</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=nd>@Bean</span> <span class=n>Binding</span> <span class=nf>ticketBinding</span><span class=o>(){</span>
</span></span><span class=line><span class=cl>    <span class=n>log</span><span class=o>.</span><span class=na>info</span><span class=o>(</span><span class=s>&#34;Create ticket binding&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>BindingBuilder</span><span class=o>.</span><span class=na>bind</span><span class=o>(</span><span class=n>queue</span><span class=o>()).</span><span class=na>to</span><span class=o>(</span><span class=n>ticketDirectExchange</span><span class=o>()).</span><span class=na>with</span><span class=o>(</span><span class=n>ticketQueueProperties</span><span class=o>.</span><span class=na>getName</span><span class=o>()).</span><span class=na>noargs</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p><img loading=lazy src=https://dev-to-uploads.s3.amazonaws.com/uploads/articles/pa9zvwka9l93aimns0bf.png alt=exchange></p><p>Perfeito, já vimos nossa exchange funcionando bonito! Tudo pronto!</p><p>Só que não! Lembre-se que o nosso publisher está enviando mensagens com a routing key correta, mas para a exchange errada, vamos mudar o código para o seguinte:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>rabbitTemplate</span><span class=o>.</span><span class=na>convertAndSend</span><span class=o>(</span><span class=s>&#34;direct.ticket&#34;</span><span class=o>,</span><span class=n>ticketQueueProperties</span><span class=o>.</span><span class=na>getName</span><span class=o>(),</span><span class=n>event</span><span class=o>.</span><span class=na>name</span><span class=o>());</span>
</span></span></code></pre></div><ul><li>Aqui deveríamos puxar esse nome da nossa ideal <code>TicketQueueProperties</code> :) para evitar esse spaghetti</li></ul><h1 id=passando-objetos---message-converters>Passando Objetos - Message Converters<a hidden class=anchor aria-hidden=true href=#passando-objetos---message-converters>#</a></h1><p>O <strong><code>AmqpTemplate</code></strong> também define vários métodos para enviar e receber mensagens que, no fim das contas, delegam tarefas para um <strong><code>MessageConverter</code></strong>. O <strong><code>MessageConverter</code></strong> fornece um método único para cada direção: um para converter para um <strong><code>Message</code></strong> e outro para converter a partir de um <strong><code>Message</code></strong>.</p><p>Definição da interface <strong><code>MessageConverter</code></strong>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>interface</span> <span class=nc>MessageConverter</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Message</span> <span class=nf>toMessage</span><span class=o>(</span><span class=n>Object</span> <span class=n>object</span><span class=o>,</span> <span class=n>MessageProperties</span> <span class=n>messageProperties</span><span class=o>)</span>
</span></span><span class=line><span class=cl>            <span class=kd>throws</span> <span class=n>MessageConversionException</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=n>Object</span> <span class=nf>fromMessage</span><span class=o>(</span><span class=n>Message</span> <span class=n>message</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>MessageConversionException</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><h2 id=simplemessageconverter>SimpleMessageConverter<a hidden class=anchor aria-hidden=true href=#simplemessageconverter>#</a></h2><p>A implementação padrão do strategy <strong><code>MessageConverter</code></strong> é chamada de <strong><code>SimpleMessageConverter</code></strong>. Este é o conversor usado por uma instância de <strong><code>RabbitTemplate</code></strong> se você não configurar explicitamente uma alternativa.</p><blockquote><p>Converts a String to a <code>[TextMessage](https://jakarta.ee/specifications/platform/9/apidocs/jakarta/jms/TextMessage.html)</code>, a byte array to a <code>[BytesMessage](https://jakarta.ee/specifications/platform/9/apidocs/jakarta/jms/BytesMessage.html)</code>, a Map to a <code>[MapMessage](https://jakarta.ee/specifications/platform/9/apidocs/jakarta/jms/MapMessage.html)</code>, and a Serializable object to a <code>[ObjectMessage](https://jakarta.ee/specifications/platform/9/apidocs/jakarta/jms/ObjectMessage.html)</code> (or vice versa).</p></blockquote><h2 id=trocando-o-conversor>Trocando o Conversor<a hidden class=anchor aria-hidden=true href=#trocando-o-conversor>#</a></h2><p>Para trabalhar com objetos serializados e desserializados para JSON, vamos usar o <code>Jackson2JsonMessageConverter</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Bean</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=n>MessageConverter</span> <span class=nf>messageConverter</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=k>new</span> <span class=n>Jackson2JsonMessageConverter</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>Colocaremos isso tanto no consumer quanto no producer :)</p><hr><h1 id=declarables-definição-dinâmica-e-declarativa-de-filas>Declarables, Definição Dinâmica e Declarativa de Filas<a hidden class=anchor aria-hidden=true href=#declarables-definição-dinâmica-e-declarativa-de-filas>#</a></h1><p>Falamos anteriormente do nosso<code>TicketQueueProperties</code> , que poderíamos melhorá-lo, é o que vamos fazer, na realidade, vamos substituí-lo.</p><p>Primeiro de tudo, vamos definir um formato declarativo para filas, exchanges e bindings que nos agrade, para mim:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>broker</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>queues</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>ticket</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>default.ticket</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>exchanges</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>ticket</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>direct.ticket</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>direct</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>bindings</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>ticket</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>exchange</span><span class=p>:</span><span class=w> </span><span class=l>direct.ticket</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>queue</span><span class=p>:</span><span class=w> </span><span class=l>default.ticket</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>routingKey</span><span class=p>:</span><span class=w> </span><span class=l>default.ticket</span><span class=w>
</span></span></span></code></pre></div><h2 id=criando-um-configurationproperties-adequado>Criando um ConfigurationProperties adequado<a hidden class=anchor aria-hidden=true href=#criando-um-configurationproperties-adequado>#</a></h2><p>A partir disso, vamos mapear essas propriedades em classes de uma maneira adequada. Chamarei a classe de <code>BrokerConfigurationProperties</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kn>package</span> <span class=nn>com.kaue.ticketservice.infrastructure.properties</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>jakarta.validation.constraints.NotEmpty</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>org.springframework.boot.context.properties.ConfigurationProperties</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>org.springframework.context.annotation.Configuration</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>java.util.Map</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>lombok.Data</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@Configuration</span>
</span></span><span class=line><span class=cl><span class=nd>@ConfigurationProperties</span><span class=o>(</span><span class=n>prefix</span> <span class=o>=</span> <span class=s>&#34;broker&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=nd>@Data</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>BrokerConfigurationProperties</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=o>,</span> <span class=n>QueueProperties</span><span class=o>&gt;</span> <span class=n>queues</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=o>,</span> <span class=n>ExchangeProperties</span><span class=o>&gt;</span> <span class=n>exchanges</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=o>,</span> <span class=n>BindingProperties</span><span class=o>&gt;</span> <span class=n>bindings</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Data</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kd>static</span> <span class=kd>class</span> <span class=nc>QueueProperties</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=nd>@NotEmpty</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>String</span> <span class=n>name</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Data</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kd>static</span> <span class=kd>class</span> <span class=nc>ExchangeProperties</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=nd>@NotEmpty</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>String</span> <span class=n>name</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>String</span> <span class=n>type</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Data</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kd>static</span> <span class=kd>class</span> <span class=nc>BindingProperties</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=nd>@NotEmpty</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>String</span> <span class=n>exchange</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=nd>@NotEmpty</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>String</span> <span class=n>queue</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=nd>@NotEmpty</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>String</span> <span class=n>routingKey</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><ul><li>Possuímos 3 maps, estruturas que linkam uma chave à sua correspondente configuração, <code>Queue</code>, <code>Exchange</code> ou <code>Binding</code> Properties.</li><li>Fazemos o mapeamento padrão, usando : <code>@ConfigurationProperties(prefix = "broker")</code>, até aqui, sem segredos 🙂</li></ul><h2 id=transformando-as-propriedades-em-objetos>Transformando as propriedades em objetos!<a hidden class=anchor aria-hidden=true href=#transformando-as-propriedades-em-objetos>#</a></h2><p>A partir de agora, o terceiro passo pode parecer simples, devemos criar beans a partir das propriedades, isso não é um problema, pelo menos não se quisermos definir os Beans da maneira que fizemos antes, apesar disso, se quisermos definir uma lista de Queues, Exchanges e Bindings, devemos usar a classe <code>Declarables</code>, e prover um bean para ela.</p><blockquote><p><a href=https://docs.spring.io/spring-amqp/api/org/springframework/amqp/core/Declarables.html>Declarables: <em>“…Used to declare multiple objects on the broker using a single bean declaration for the collection.”</em></a></p></blockquote><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Bean</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=n>Declarables</span> <span class=nf>es</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=k>new</span> <span class=n>Declarables</span><span class=o>(</span>
</span></span><span class=line><span class=cl>    <span class=k>new</span> <span class=n>DirectExchange</span><span class=o>(</span><span class=s>&#34;e2&#34;</span><span class=o>,</span> <span class=kc>false</span><span class=o>,</span> <span class=kc>true</span><span class=o>),</span>
</span></span><span class=line><span class=cl>    <span class=k>new</span> <span class=n>DirectExchange</span><span class=o>(</span><span class=s>&#34;e3&#34;</span><span class=o>,</span> <span class=kc>false</span><span class=o>,</span> <span class=kc>true</span><span class=o>));</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@Bean</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=n>Declarables</span> <span class=nf>qs</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=k>new</span> <span class=n>Declarables</span><span class=o>(</span>
</span></span><span class=line><span class=cl>    <span class=k>new</span> <span class=n>Queue</span><span class=o>(</span><span class=s>&#34;q2&#34;</span><span class=o>,</span> <span class=kc>false</span><span class=o>,</span> <span class=kc>false</span><span class=o>,</span> <span class=kc>true</span><span class=o>),</span>
</span></span><span class=line><span class=cl>    <span class=k>new</span> <span class=n>Queue</span><span class=o>(</span><span class=s>&#34;q3&#34;</span><span class=o>,</span> <span class=kc>false</span><span class=o>,</span> <span class=kc>false</span><span class=o>,</span> <span class=kc>true</span><span class=o>));</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@Bean</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=n>Declarables</span> <span class=nf>bs</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=k>new</span> <span class=n>Declarables</span><span class=o>(</span>
</span></span><span class=line><span class=cl>    <span class=k>new</span> <span class=n>Binding</span><span class=o>(</span><span class=s>&#34;q2&#34;</span><span class=o>,</span> <span class=n>DestinationType</span><span class=o>.</span><span class=na>QUEUE</span><span class=o>,</span> <span class=s>&#34;e2&#34;</span><span class=o>,</span> <span class=s>&#34;k2&#34;</span><span class=o>,</span> <span class=kc>null</span><span class=o>),</span>
</span></span><span class=line><span class=cl>    <span class=k>new</span> <span class=n>Binding</span><span class=o>(</span><span class=s>&#34;q3&#34;</span><span class=o>,</span> <span class=n>DestinationType</span><span class=o>.</span><span class=na>QUEUE</span><span class=o>,</span> <span class=s>&#34;e3&#34;</span><span class=o>,</span> <span class=s>&#34;k3&#34;</span><span class=o>,</span> <span class=kc>null</span><span class=o>));</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>O exemplo acima, <a href=https://docs.spring.io/spring-amqp/reference/html/#collection-declaration>da documentação de referência do spring</a>, é uma boa forma de exemplificar o uso mais simples de Declarables, vamos ver minha implementação em particular, que adiciona declarables de acordo com a <code>BrokerConfigurationProperties</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kn>package</span> <span class=nn>com.kaue.ticketservice.infrastructure.configuration</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// ... ommitted
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * This classes creates all queues, exchanges and bindings based on application.yaml when they&#39;re needed (called by a consumer or posted a message into).
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nd>@Configuration</span>
</span></span><span class=line><span class=cl><span class=nd>@Slf4j</span>
</span></span><span class=line><span class=cl><span class=nd>@RequiredArgsConstructor</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>RabbitMqConfiguration</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kd>final</span> <span class=n>BrokerConfigurationProperties</span> <span class=n>brokerConfig</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kd>final</span> <span class=n>List</span><span class=o>&lt;</span><span class=n>Queue</span><span class=o>&gt;</span> <span class=n>definedQueues</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ArrayList</span><span class=o>&lt;&gt;();</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kd>final</span> <span class=n>List</span><span class=o>&lt;</span><span class=n>Exchange</span><span class=o>&gt;</span> <span class=n>definedExchanges</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ArrayList</span><span class=o>&lt;&gt;();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Bean</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=n>Declarables</span> <span class=nf>queues</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>brokerConfig</span> <span class=o>==</span> <span class=kc>null</span> <span class=o>||</span> <span class=n>brokerConfig</span><span class=o>.</span><span class=na>getQueues</span><span class=o>()</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=k>new</span> <span class=n>Declarables</span><span class=o>();</span> <span class=c1>// Return an empty list if no queues are configured
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>var</span> <span class=n>queueList</span> <span class=o>=</span> <span class=n>brokerConfig</span><span class=o>.</span><span class=na>getQueues</span><span class=o>().</span><span class=na>values</span><span class=o>().</span><span class=na>stream</span><span class=o>()</span>
</span></span><span class=line><span class=cl>      <span class=o>.</span><span class=na>filter</span><span class=o>(</span><span class=n>Objects</span><span class=o>::</span><span class=n>nonNull</span><span class=o>)</span>
</span></span><span class=line><span class=cl>      <span class=o>.</span><span class=na>map</span><span class=o>(</span><span class=n>queueProperties</span> <span class=o>-&gt;</span> <span class=k>new</span> <span class=n>Queue</span><span class=o>(</span><span class=n>queueProperties</span><span class=o>.</span><span class=na>getName</span><span class=o>(),</span> <span class=kc>true</span><span class=o>))</span>
</span></span><span class=line><span class=cl>      <span class=o>.</span><span class=na>toList</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>definedQueues</span><span class=o>.</span><span class=na>addAll</span><span class=o>(</span><span class=n>queueList</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>log</span><span class=o>.</span><span class=na>info</span><span class=o>(</span><span class=s>&#34;Declared queues&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=k>new</span> <span class=n>Declarables</span><span class=o>(</span><span class=n>queueList</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=nd>@Bean</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=n>Declarables</span> <span class=nf>exchanges</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>brokerConfig</span> <span class=o>==</span> <span class=kc>null</span> <span class=o>||</span> <span class=n>brokerConfig</span><span class=o>.</span><span class=na>getExchanges</span><span class=o>()</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=k>new</span> <span class=n>Declarables</span><span class=o>();</span> <span class=c1>// Return an empty list if no exchanges are configured
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>var</span> <span class=n>exchangesList</span> <span class=o>=</span> <span class=n>brokerConfig</span><span class=o>.</span><span class=na>getExchanges</span><span class=o>().</span><span class=na>values</span><span class=o>().</span><span class=na>stream</span><span class=o>()</span>
</span></span><span class=line><span class=cl>      <span class=o>.</span><span class=na>filter</span><span class=o>(</span><span class=n>Objects</span><span class=o>::</span><span class=n>nonNull</span><span class=o>)</span>
</span></span><span class=line><span class=cl>      <span class=o>.</span><span class=na>map</span><span class=o>(</span><span class=n>exchangeProperties</span> <span class=o>-&gt;</span> <span class=k>new</span> <span class=n>DirectExchange</span><span class=o>(</span><span class=n>exchangeProperties</span><span class=o>.</span><span class=na>getName</span><span class=o>()))</span> <span class=c1>// todo use correct exchange type
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=o>.</span><span class=na>toList</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>definedExchanges</span><span class=o>.</span><span class=na>addAll</span><span class=o>(</span><span class=n>exchangesList</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>log</span><span class=o>.</span><span class=na>info</span><span class=o>(</span><span class=s>&#34;Declared exchanges&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=k>new</span> <span class=n>Declarables</span><span class=o>(</span><span class=n>exchangesList</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=nd>@Bean</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=n>Declarables</span> <span class=nf>bindings</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>brokerConfig</span> <span class=o>==</span> <span class=kc>null</span> <span class=o>||</span> <span class=n>brokerConfig</span><span class=o>.</span><span class=na>getBindings</span><span class=o>()</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=k>new</span> <span class=n>Declarables</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>var</span> <span class=n>bindingsList</span> <span class=o>=</span> <span class=n>brokerConfig</span><span class=o>.</span><span class=na>getBindings</span><span class=o>().</span><span class=na>values</span><span class=o>().</span><span class=na>stream</span><span class=o>()</span>
</span></span><span class=line><span class=cl>        <span class=o>.</span><span class=na>map</span><span class=o>(</span><span class=n>bindingProperties</span> <span class=o>-&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>          <span class=n>log</span><span class=o>.</span><span class=na>info</span><span class=o>(</span><span class=s>&#34;Creating binding between exchange {} and queue {} with routing key {}&#34;</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                  <span class=n>bindingProperties</span><span class=o>.</span><span class=na>getExchange</span><span class=o>(),</span> <span class=n>bindingProperties</span><span class=o>.</span><span class=na>getQueue</span><span class=o>(),</span> <span class=n>bindingProperties</span><span class=o>.</span><span class=na>getRoutingKey</span><span class=o>());</span>
</span></span><span class=line><span class=cl>          <span class=n>Queue</span> <span class=n>queue</span> <span class=o>=</span> <span class=n>findQueueByName</span><span class=o>(</span><span class=n>bindingProperties</span><span class=o>.</span><span class=na>getQueue</span><span class=o>());</span>
</span></span><span class=line><span class=cl>          <span class=n>Exchange</span> <span class=n>exchange</span> <span class=o>=</span> <span class=n>findExchangeByName</span><span class=o>(</span><span class=n>bindingProperties</span><span class=o>.</span><span class=na>getExchange</span><span class=o>());</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>          <span class=k>return</span> <span class=n>BindingBuilder</span><span class=o>.</span><span class=na>bind</span><span class=o>(</span><span class=n>queue</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                  <span class=o>.</span><span class=na>to</span><span class=o>(</span><span class=n>exchange</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                  <span class=o>.</span><span class=na>with</span><span class=o>(</span><span class=n>bindingProperties</span><span class=o>.</span><span class=na>getRoutingKey</span><span class=o>())</span>
</span></span><span class=line><span class=cl>                  <span class=o>.</span><span class=na>noargs</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>})</span>
</span></span><span class=line><span class=cl>        <span class=o>.</span><span class=na>toList</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=k>new</span> <span class=n>Declarables</span><span class=o>(</span><span class=n>bindingsList</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=n>Queue</span> <span class=nf>findQueueByName</span> <span class=o>(</span><span class=n>String</span> <span class=n>queueName</span><span class=o>){</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=n>definedQueues</span><span class=o>.</span><span class=na>stream</span><span class=o>()</span>
</span></span><span class=line><span class=cl>              <span class=o>.</span><span class=na>filter</span><span class=o>(</span><span class=n>queue</span> <span class=o>-&gt;</span> <span class=n>queueName</span><span class=o>.</span><span class=na>equals</span><span class=o>(</span><span class=n>queue</span><span class=o>.</span><span class=na>getName</span><span class=o>()))</span>
</span></span><span class=line><span class=cl>              <span class=o>.</span><span class=na>findFirst</span><span class=o>()</span>
</span></span><span class=line><span class=cl>              <span class=o>.</span><span class=na>orElse</span><span class=o>(</span><span class=kc>null</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>Exchange</span> <span class=nf>findExchangeByName</span> <span class=o>(</span><span class=n>String</span> <span class=n>exchangeName</span><span class=o>){</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=n>definedExchanges</span><span class=o>.</span><span class=na>stream</span><span class=o>()</span>
</span></span><span class=line><span class=cl>              <span class=o>.</span><span class=na>filter</span><span class=o>(</span><span class=n>exchange</span> <span class=o>-&gt;</span> <span class=n>exchangeName</span><span class=o>.</span><span class=na>equals</span><span class=o>(</span><span class=n>exchange</span><span class=o>.</span><span class=na>getName</span><span class=o>()))</span>
</span></span><span class=line><span class=cl>              <span class=o>.</span><span class=na>findFirst</span><span class=o>()</span>
</span></span><span class=line><span class=cl>              <span class=o>.</span><span class=na>orElse</span><span class=o>(</span><span class=kc>null</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span></code></pre></div><p>Embora grande, a implementação é relativamente simples, usamos streams para transformar as propriedades em classes reais e retornamos o Declarable como um <code>Bean</code>, um objeto gerenciado pelo spring.</p><h1 id=poderes-de-rabbitlistener>Poderes de RabbitListener<a hidden class=anchor aria-hidden=true href=#poderes-de-rabbitlistener>#</a></h1><p>No Spring, quando um método anotado como listener joga uma exception, as mensagens podem ser inseridas novamente na fila e reprocessadas, descartadas ou colocadas em uma Dead Letter Queue. Nada é devolvido ao emissor da mensagem.</p><h2 id=error-handling>Error Handling<a hidden class=anchor aria-hidden=true href=#error-handling>#</a></h2><p>Na versão 2.0 do Spring AMQP em diante, @RabbitLisetener tem 2 atributos: <code>errorHandler</code> e<code>returnExceptions</code>, mas eles não são configurados por padrão.</p><p>Você pode usar o <code>errorHandler</code> para prover um Bean de <code>RabbitListenerErrorHandler</code>. Essa interface funcional tem um método:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@FunctionalInterface</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>interface</span> <span class=nc>RabbitListenerErrorHandler</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Object</span> <span class=nf>handleError</span><span class=o>(</span><span class=n>Message</span> <span class=n>amqpMessage</span><span class=o>,</span> <span class=n>org</span><span class=o>.</span><span class=na>springframework</span><span class=o>.</span><span class=na>messaging</span><span class=o>.</span><span class=na>Message</span><span class=o>&lt;?&gt;</span> <span class=n>message</span><span class=o>,</span>
</span></span><span class=line><span class=cl>              <span class=n>ListenerExecutionFailedException</span> <span class=n>exception</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>Aqui, por exemplo, poderíamos dizer que exceções de serviço ou fatais jogam exceções <strong><code>AmqpRejectAndDontRequeueException</code>,</strong> para evitar requeue.</p><blockquote><p>As you can see, you have access to the raw message received from the container, the spring-messaging <code>Message&lt;?></code> object produced by the message converter, and the exception that was thrown by the listener (wrapped in a <code>ListenerExecutionFailedException</code>). The error handler can either return some result (which is sent as the reply) or throw the original or a new exception (which is thrown to the container or returned to the sender, depending on the <code>returnExceptions</code> setting).</p></blockquote><p>A citação acima comenta uma maneira de enviar exceptions de volta ao sender, se te interessar, pode <a href=https://docs.spring.io/spring-amqp/docs/current/reference/html/#annotation-error-handling>ver aqui</a></p><h2 id=retries>Retries!<a hidden class=anchor aria-hidden=true href=#retries>#</a></h2><p>Podemos customizar e modificar configurações de retry indicadas dentro do nosso projeto, para isso usaremos o projeto <code>spring-retry</code>, vamos ver uma configuração simples no <code>Bean</code> do <code>RabbitTemplate</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Bean</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=n>RabbitTemplate</span> <span class=nf>rabbitTemplate</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>RabbitTemplate</span> <span class=n>template</span> <span class=o>=</span> <span class=k>new</span> <span class=n>RabbitTemplate</span><span class=o>(</span><span class=n>connectionFactory</span><span class=o>());</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=n>RetryTemplate</span> <span class=n>retryTemplate</span> <span class=o>=</span> <span class=n>RetryTemplate</span><span class=o>.</span><span class=na>builder</span><span class=o>()</span>
</span></span><span class=line><span class=cl>				<span class=o>.</span><span class=na>maxAttempts</span><span class=o>(</span><span class=mi>3</span><span class=o>)</span>
</span></span><span class=line><span class=cl>				<span class=o>.</span><span class=na>fixedBackoff</span><span class=o>(</span><span class=mi>1000</span><span class=o>)</span>
</span></span><span class=line><span class=cl>				<span class=o>.</span><span class=na>retryOn</span><span class=o>(</span><span class=n>RemoteAccessException</span><span class=o>.</span><span class=na>class</span><span class=o>)</span>
</span></span><span class=line><span class=cl>				<span class=o>.</span><span class=na>build</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=n>retryTemplate</span><span class=o>.</span><span class=na>execute</span><span class=o>(</span><span class=n>ctx</span> <span class=o>-&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>		    <span class=c1>// ... do something
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=o>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>template</span><span class=o>.</span><span class=na>setRetryTemplate</span><span class=o>(</span><span class=n>retryTemplate</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>template</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>Para mais informações, veja o <code>[spring-retry](https://github.com/spring-projects/spring-retry#using-retrytemplate)</code></p><h1 id=dead-letters>Dead Letters<a hidden class=anchor aria-hidden=true href=#dead-letters>#</a></h1><blockquote><p>When a listener throws an exception, it is wrapped in a <code>ListenerExecutionFailedException</code>. Normally the message is rejected and requeued by the broker. Setting <code>defaultRequeueRejected</code> to <code>false</code> causes messages to be discarded (or routed to a dead letter exchange).</p></blockquote><p>Vamos tentar seguir o que o comentário acima da documentação do spring diz:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>spring</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nt>rabbitmq </span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=l>... adresses e outras configs</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nt>listener</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=nt>simple</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=nt>default-requeue-rejected</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></span></span></code></pre></div><p>Depois dessa configuração, as mensagens quando possuem um erro são DELETADAS, desabilitando os retries. Isso provavelmente não é o que queremos, por isso, vamos estudar as DLQ’s.</p><p>Dead Letter Queues (DLQ) são filas que possuem mensagens que tiveram sua execução falhada em algum momento, o comportamento das DLQ’s pode ser configurado no próprio broker.</p><p>Dead Letter Queues são úteis em sistemas mais críticos, onde necessitamos que um job rode de qualquer forma, onde podemos jogar mensagens de DLQ’s na exchange padrão novamente, ou pelo menos entendermos o porquê daquilo não ter sido executado, essas filas possuem diversas funções.</p><p>A maneira de definir dead letters é algo explicado dentro do protocolo AMQP, podemos apenas seguir essa configuração:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Bean</span>
</span></span><span class=line><span class=cl><span class=n>Queue</span> <span class=nf>messagesQueue</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>QueueBuilder</span><span class=o>.</span><span class=na>durable</span><span class=o>(</span><span class=s>&#34;queue-name&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>      <span class=o>.</span><span class=na>withArgument</span><span class=o>(</span><span class=s>&#34;x-dead-letter-exchange&#34;</span><span class=o>,</span> <span class=s>&#34;nome-exchange.dlx&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>      <span class=o>.</span><span class=na>withArgument</span><span class=o>(</span><span class=s>&#34;x-dead-letter-routing-key&#34;</span><span class=o>,</span> <span class=s>&#34;queue-name.dlq&#34;</span><span class=o>)</span> <span class=c1>// nao precisa ser o nome da queue, mas é comum para direct
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=o>.</span><span class=na>build</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=nd>@Bean</span>
</span></span><span class=line><span class=cl><span class=n>Queue</span> <span class=nf>deadLetterQueue</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>QueueBuilder</span><span class=o>.</span><span class=na>durable</span><span class=o>(</span><span class=s>&#34;queue-name.dlq&#34;</span><span class=o>).</span><span class=na>build</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>No fim das contas, uma dead letter queue é uma queue normal, e uma dead letter exchange também, portanto, se uma mensagem chegar na DLX (Dead Letter Exchange) e não tiver uma routing key correta, ela não chegará na fila, tudo normal por aqui.</p><h1 id=observações>Observações<a hidden class=anchor aria-hidden=true href=#observações>#</a></h1><p>Existem diversas maneiras de trabalhar com rabbitMQ, e uma infinidade de propriedades e configurações não mostradas aqui, como por exemplo: Feedback síncrono de exchanges e filas, Consumers Assíncronos, Containers Diferentes, propriedades de requeue, monitoramento de consumers, etc. Se algo fizer sentido para seu contexto, pode buscar no material de referência do Spring 🙂</p><p>Mais sobre DLQ: <a href="https://www.youtube.com/watch?v=GgIJWxk_-jM">https://www.youtube.com/watch?v=GgIJWxk_-jM</a></p><p>Mais sobre exception handling: <a href=https://www.baeldung.com/spring-amqp-error-handling>https://www.baeldung.com/spring-amqp-error-handling</a></p><h1 id=referências>Referências<a hidden class=anchor aria-hidden=true href=#referências>#</a></h1><p><a href=https://docs.spring.io/spring-amqp/reference/html/#template-retry>https://docs.spring.io/spring-amqp/reference/html/#template-retry</a></p><p><a href=https://github.com/spring-projects/spring-retry>https://github.com/spring-projects/spring-retry</a></p><p><a href=https://www.baeldung.com/spring-amqp-error-handling>https://www.baeldung.com/spring-amqp-error-handling</a></p></div><footer class=post-footer><ul class=post-tags><li><a href=https://kaue.cat/tags/spring/>SPRING</a></li><li><a href=https://kaue.cat/tags/java/>JAVA</a></li><li><a href=https://kaue.cat/tags/rabbitmq/>RABBITMQ</a></li></ul><nav class=paginav><a class=prev href=https://kaue.cat/posts/solid/><span class=title>« Página Anterior</span><br><span>SOLID! Um Post Aprofundado</span></a>
<a class=next href=https://kaue.cat/posts/java_rabbitmq_parte1/><span class=title>Próxima Página »</span><br><span>RabbitMQ com Java e Spring : Começando (pt. 1)</span></a></nav><div class=share-buttons><a>Compartilhar:</a><br><a target=_blank rel="noopener noreferrer" aria-label="share RabbitMQ com Java e Spring : Entendendo de verdade e com um toque de elegância (parte 2) on x" href="https://x.com/intent/tweet/?text=RabbitMQ%20com%20Java%20e%20Spring%20%3a%20Entendendo%20de%20verdade%20e%20com%20um%20toque%20de%20eleg%c3%a2ncia%20%28parte%202%29&url=https%3a%2f%2fkaue.cat%2fposts%2fjava_rabbitmq_parte2%2f&hashtags=SPRING%2cJAVA%2cRABBITMQ"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share RabbitMQ com Java e Spring : Entendendo de verdade e com um toque de elegância (parte 2) on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fkaue.cat%2fposts%2fjava_rabbitmq_parte2%2f&title=RabbitMQ%20com%20Java%20e%20Spring%20%3a%20Entendendo%20de%20verdade%20e%20com%20um%20toque%20de%20eleg%c3%a2ncia%20%28parte%202%29&summary=RabbitMQ%20com%20Java%20e%20Spring%20%3a%20Entendendo%20de%20verdade%20e%20com%20um%20toque%20de%20eleg%c3%a2ncia%20%28parte%202%29&source=https%3a%2f%2fkaue.cat%2fposts%2fjava_rabbitmq_parte2%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share RabbitMQ com Java e Spring : Entendendo de verdade e com um toque de elegância (parte 2) on whatsapp" href="https://api.whatsapp.com/send?text=RabbitMQ%20com%20Java%20e%20Spring%20%3a%20Entendendo%20de%20verdade%20e%20com%20um%20toque%20de%20eleg%c3%a2ncia%20%28parte%202%29%20-%20https%3a%2f%2fkaue.cat%2fposts%2fjava_rabbitmq_parte2%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></div></footer><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//www-kaue-cat.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></article></main><footer class=footer><span>&copy; 2024 <a href=https://kaue.cat>Kaue Gatto</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>