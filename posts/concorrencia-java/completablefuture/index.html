<!doctype html><html lang=pt dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>5. CompletableFuture - Dominando o Assíncrono em Java! | Kaue Gatto</title><meta name=keywords content="Concorrencia,JAVA"><meta name=description content="Sabemos como lidar com multiplas threads, evitar race conditions, entendemos pooling e sabemos o porquê devemos usar mecanismos assíncronos, agora, vamos entender a API moderna do JAVA para lidar com comportamentos assíncronos e paralelos."><meta name=author content="Me"><link rel=canonical href=https://kaue.cat/posts/concorrencia-java/completablefuture/><meta name=google-site-verification content="G-6MZTJBEG75"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.5cfc680b1eeaeef9efbced92d46c2a9e876b72ee14fba85846afc4cff9e6e6f8.css integrity="sha256-XPxoCx7q7vnvvO2S1Gwqnodrcu4U+6hYRq/Ez/nm5vg=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://raw.githubusercontent.com/kauegatto/hugo-PaperMod/6aab706f2e2053433e33f8fd45dbec615f4d479f/images/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://raw.githubusercontent.com/kauegatto/hugo-PaperMod/6aab706f2e2053433e33f8fd45dbec615f4d479f/images/favicon.ico><link rel=icon type=image/png sizes=32x32 href=https://raw.githubusercontent.com/kauegatto/hugo-PaperMod/6aab706f2e2053433e33f8fd45dbec615f4d479f/images/favicon.ico><link rel=apple-touch-icon href=https://raw.githubusercontent.com/kauegatto/hugo-PaperMod/6aab706f2e2053433e33f8fd45dbec615f4d479f/images/favicon.ico><link rel=mask-icon href=https://raw.githubusercontent.com/kauegatto/hugo-PaperMod/6aab706f2e2053433e33f8fd45dbec615f4d479f/images/favicon.ico><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=pt href=https://kaue.cat/posts/concorrencia-java/completablefuture/><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-6MZTJBEG75"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-6MZTJBEG75",{anonymize_ip:!1})}</script><script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","G-6MZTJBEG75","auto"),ga("send","pageview"))</script><script async src=https://www.google-analytics.com/analytics.js></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-6MZTJBEG75"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-6MZTJBEG75",{anonymize_ip:!1})}</script><meta property="og:title" content="5. CompletableFuture - Dominando o Assíncrono em Java!"><meta property="og:description" content="Sabemos como lidar com multiplas threads, evitar race conditions, entendemos pooling e sabemos o porquê devemos usar mecanismos assíncronos, agora, vamos entender a API moderna do JAVA para lidar com comportamentos assíncronos e paralelos."><meta property="og:type" content="article"><meta property="og:url" content="https://kaue.cat/posts/concorrencia-java/completablefuture/"><meta property="og:image" content="https://kaue.cat/%3Cimage%20path/url%3E"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-04-05T20:18:37+00:00"><meta property="article:modified_time" content="2024-04-05T20:18:37+00:00"><meta property="og:site_name" content="Kaue Gatto - Blog de Desenvolvimento"><meta property="og:see_also" content="https://kaue.cat/posts/concorrencia-java/virtual-threads/"><meta property="og:see_also" content="https://kaue.cat/posts/concorrencia-java/executors-e-threadpools/"><meta property="og:see_also" content="https://kaue.cat/posts/concorrencia-java/thread-safe/"><meta property="og:see_also" content="https://kaue.cat/posts/concorrencia-java/desafios/"><meta property="og:see_also" content="https://kaue.cat/posts/concorrencia-java/threads-java/"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://kaue.cat/%3Cimage%20path/url%3E"><meta name=twitter:title content="5. CompletableFuture - Dominando o Assíncrono em Java!"><meta name=twitter:description content="Sabemos como lidar com multiplas threads, evitar race conditions, entendemos pooling e sabemos o porquê devemos usar mecanismos assíncronos, agora, vamos entender a API moderna do JAVA para lidar com comportamentos assíncronos e paralelos."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://kaue.cat/posts/"},{"@type":"ListItem","position":3,"name":"5. CompletableFuture - Dominando o Assíncrono em Java!","item":"https://kaue.cat/posts/concorrencia-java/completablefuture/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"5. CompletableFuture - Dominando o Assíncrono em Java!","name":"5. CompletableFuture - Dominando o Assíncrono em Java!","description":"Sabemos como lidar com multiplas threads, evitar race conditions, entendemos pooling e sabemos o porquê devemos usar mecanismos assíncronos, agora, vamos entender a API moderna do JAVA para lidar com comportamentos assíncronos e paralelos.","keywords":["Concorrencia","JAVA"],"articleBody":"Seja bem vindo, esse daqui é o quinto de 6 posts sobre concorrência em Java. A série é focada em Java, mas esse post em especial apresenta conceitos relevantes para literalmente todas as linguagens e também não é uma leitura muito extensiva :).\nNosso roteiro é:\nThreads! Processando em Paralelo e Ganhando Throughput Sincronização de Threads - DeadLocks, Zonas Críticas e Condições de Corrida Concorrência, agora melhor - Classes Thread Safe Executors, Thread Pools e Futures CompletableFuture Virtual Threads Introdução e “Join” Suponha esse código:\nStoreService\npackage DCompletableFuture; import java.util.concurrent.ExecutorService; import java.util.concurrent.Future; import java.util.concurrent.ThreadLocalRandom; import java.util.concurrent.TimeUnit; public class StoreService { private final ExecutorService executorService; public StoreService(ExecutorService executorService) { this.executorService = executorService; } public Double getPricesSync() throws InterruptedException { return getPrices(); } public Future\u003cDouble\u003e getPricesAsync() { return executorService.submit(this::getPrices); } private Double getPrices() throws InterruptedException { System.out.println(\"Getting prices...\"); TimeUnit.SECONDS.sleep(1); return ThreadLocalRandom.current().nextDouble(20,200)*3; } } Main\npackage DCompletableFuture; import java.util.concurrent.ExecutorService; import java.util.concurrent.Executors; public class Main { public static void main(String[] args) { var ex = Executors.newFixedThreadPool(2); ex.submit(Main::searchPricesAsync); ex.submit(Main::searchPricesSync); } private static void searchPricesSync(){ final ExecutorService ex = Executors.newFixedThreadPool(3); StoreService storeService = new StoreService(ex); try { System.out.println(storeService.getPricesSync()); System.out.println(storeService.getPricesSync()); System.out.println(storeService.getPricesSync()); System.out.println(storeService.getPricesSync()); System.out.println(storeService.getPricesSync()); } catch (InterruptedException e) { e.printStackTrace(); } } private static void searchPricesAsync() { final ExecutorService ex = Executors.newFixedThreadPool(5); StoreService storeService = new StoreService(ex); try { System.out.println(storeService.getPricesAsync().get()); System.out.println(storeService.getPricesAsync().get()); System.out.println(storeService.getPricesAsync().get()); System.out.println(storeService.getPricesAsync().get()); System.out.println(storeService.getPricesAsync().get()); } catch (Exception e) { e.printStackTrace(); } } } No caso, estamos executando as operações de busca sync e async simultaneamente (uma em cada thread) e para cada uma delas, estamos submetendo as tarefas as threads e pegando seus resultados de maneira síncrona e sem usar todas nossas threads.\nPera, mas se getPricesAsync nos retorna uma Future, como isso é síncrono? Embora o processamento esteja sendo realizado paralelamente, nosso código fica realmente bloqueado, esperando pela resposta do storeService.getPricesAsync(), e ele só faz o pedido de busca do próximo código assíncrono quando o anterior termina, portanto, não estamos submetendo todas as tasks antes de esperá-las.\n[❗] Atenção Note que aqui, o processameto síncrono é o problema pois estamos bloqueando a thread que realiza searchPricesAsync, fazendo com que ela só peça que a próxima execução aconteça quanto a anterior terminar. Mesmo que isso esteja sendo executado em uma thread auxiliar, estamos esperando a thread terminar seu trabalho para continuarmos o nosso.\nA solução seria dividir em duas partes:\nprivate static void searchPricesAsync() { final ExecutorService ex = Executors.newFixedThreadPool( 5); StoreService storeService = new StoreService(ex); Future\u003cDouble\u003e pricesAsyncFuture1 = storeService.getPricesAsync(); Future\u003cDouble\u003e pricesAsyncFuture2 = storeService.getPricesAsync(); Future\u003cDouble\u003e pricesAsyncFuture3 = storeService.getPricesAsync(); Future\u003cDouble\u003e pricesAsyncFuture4 = storeService.getPricesAsync(); Future\u003cDouble\u003e pricesAsyncFuture5 = storeService.getPricesAsync(); try { System.out.println(pricesAsyncFuture1.get()); System.out.println(pricesAsyncFuture2.get()); System.out.println(pricesAsyncFuture3.get()); System.out.println(pricesAsyncFuture4.get()); System.out.println(pricesAsyncFuture5.get()); } catch (Exception e) { e.printStackTrace(); } } E agora sim temos essa belezinha de resultado:\nGetting prices... - pool-2-thread-4 Getting prices... - pool-2-thread-3 Getting prices... - pool-2-thread-1 Getting prices... - pool-2-thread-2 Getting prices... - pool-1-thread-2 Getting prices... - pool-2-thread-5 Apesar disso, o código não é tão bonito assim, né? Vamos ver uma evolução dos Futures - CompletableFutures\npublic CompletableFuture\u003cDouble\u003e getPricesWithCompletableFuture() { return CompletableFuture.supplyAsync(() -\u003e { try { return getPrices(); } catch (InterruptedException e) { throw new RuntimeException(e); } }); } Aqui, note que só temos esse try porque getPricesRealmente pode jogar uma InterruptedException.\nPerceba também que não passamos o executor para o supplyAsync (poderíamos), mas ele possuí um executor “nativo”: According to the official documentation, if we use the async methods without explicitly providing an Executor, the functions will be executed using ForkJoinPool.commonPool(). Therefore, if we run the code snippet, we should expect to see one of the common ForkJoinPool workers: in my case, “ForkJoinPool.commonPool-worker-1″. - https://www.baeldung.com/java-completablefuture-threadpool#async-methods\nprivate static void searchPricesAsync() { final ExecutorService ex = Executors.newFixedThreadPool( 5); StoreService storeService = new StoreService(ex); CompletableFuture\u003cDouble\u003e pricesAsyncCompletableFuture1 = storeService.getPricesWithCompletableFuture(); CompletableFuture\u003cDouble\u003e pricesAsyncCompletableFuture2 = storeService.getPricesWithCompletableFuture(); CompletableFuture\u003cDouble\u003e pricesAsyncCompletableFuture3 = storeService.getPricesWithCompletableFuture(); CompletableFuture\u003cDouble\u003e pricesAsyncCompletableFuture4 = storeService.getPricesWithCompletableFuture(); CompletableFuture\u003cDouble\u003e pricesAsyncCompletableFuture5 = storeService.getPricesWithCompletableFuture(); System.out.println(pricesAsyncCompletableFuture1.join()); System.out.println(pricesAsyncCompletableFuture2.join()); System.out.println(pricesAsyncCompletableFuture3.join()); System.out.println(pricesAsyncCompletableFuture4.join()); System.out.println(pricesAsyncCompletableFuture5.join()); } Aqui, note que já não precisamos usar try/catch nos joins, equivalente ao .get() do CompletableFuture\nUso com Streams! [☣️] Cuidado com Streams! Ao usarmos CompletableFuture com streams, precisamos ter um cuidado, nossas streams não podem iterar a lista de CompletableFutures usando join, senão, voltamos ao cenário do processamento síncrono, o correto é retornar essa stream em duas partes diferentes, uma que realiza o supply das tarefas para as threads e outra que realmente executa o join.\npublic class Main { private static final StoreServiceSync storeService = new StoreServiceSync(); private static final Set\u003cString\u003e STORES = Set.of(\"BestPrice\", \"LetsSaveBig\", \"MyFavoriteShop\", \"BuyItAll\"); public static void main(String[] args) { searchPricesWithDiscount(); searchPricesWithDiscountAsync(); } private static void searchPricesWithDiscount(){ long start = System.currentTimeMillis(); STORES.stream() .map(store -\u003e storeService.getQuote(store)) .peek(System.out::println) .map(quote -\u003e storeService.applyDiscount(quote)) .forEach(System.out::println); long end = System.currentTimeMillis(); System.out.printf(\"[SYNC] Time elapsed: %d ms\", end - start); } private static void searchPricesWithDiscountAsync(){ long start = System.currentTimeMillis(); List\u003cCompletableFuture\u003cQuote\u003e\u003e quotesFutures = STORES.stream() .map(store -\u003e CompletableFuture.supplyAsync(() -\u003e storeService.getQuote(store))) .toList(); List\u003cQuote\u003e quotes = quotesFutures.stream() .map(quoteCompletableFuture -\u003e quoteCompletableFuture.join()) .peek(System.out::println) .toList(); List\u003cCompletableFuture\u003cString\u003e\u003e pricesFutures = quotes.stream() .map(currQuote -\u003e CompletableFuture.supplyAsync(() -\u003e storeService.applyDiscount(currQuote))) .toList(); List\u003cString\u003e prices = pricesFutures .stream() .map(priceFuture -\u003e priceFuture.join()) .peek(System.out::println) .toList(); long end = System.currentTimeMillis(); System.out.printf(\"[ASYNC] Time elapsed: %d ms\", end - start); } } Aqui, note que tanto as operações de getQuote quanto as de applyDiscount são assíncronas, portanto, elas foram divididas em duas partes cada Resultados:\nQuote[store=MyFavoriteShop, price=60.0, discountCode=GOLD] MyFavoriteShop price is 54.00 Quote[store=BuyItAll, price=430.0, discountCode=DIAMOND] BuyItAll price is 344.00 Quote[store=LetsSaveBig, price=1300.0, discountCode=DIAMOND] LetsSaveBig price is 1040.00 Quote[store=BestPrice, price=150.0, discountCode=SILVER] BestPrice price is 142.50 [SYNC] Time elapsed: 16031 Quote[store=MyFavoriteShop, price=4430.0, discountCode=DIAMOND] Quote[store=BuyItAll, price=180.0, discountCode=DIAMOND] Quote[store=LetsSaveBig, price=690.0, discountCode=PLATINUM] Quote[store=BestPrice, price=1670.0, discountCode=SILVER] MyFavoriteShop price is 3544.00 BuyItAll price is 144.00 LetsSaveBig price is 586.50 BestPrice price is 1586.50 [ASYNC] Time elapsed: 4014 ms O código funcionou bem, mas está bem verboso, vamos melhorá-lo:\nEncadeando chamadas: ThenCompose O método thenCompose é utilizado para encadear operações de forma que a segunda operação dependa do resultado da primeira, retornando um novo CompletableFuture. No exemplo a seguir, utilizamos thenCompose para aplicar o desconto após obter a cotação de forma assíncrona:\nprivate static void searchPricesWithDiscountAsyncNew(){ long start = System.currentTimeMillis(); List\u003cCompletableFuture\u003cString\u003e\u003e stringFutures = STORES.stream() .map(store -\u003e CompletableFuture.supplyAsync(() -\u003e storeService.getQuote(store))) .map(cf -\u003e cf.thenCompose(quote -\u003e CompletableFuture.supplyAsync(() -\u003e storeService.applyDiscount(quote)))) .toList(); stringFutures.stream() .map(stringFuture -\u003e stringFuture.join()) .forEach(System.out::println); long end = System.currentTimeMillis(); System.out.printf(\"[NEW ASYNC] Time elapsed: %d ms\\n\", end - start); } Neste exemplo, thenCompose é utilizado para encadear a obtenção da cotação (getQuote) com a aplicação do desconto (applyDiscount) de forma assíncrona, resultando em um código mais conciso e legível.\nThenApply O método thenApply é utilizado quando queremos transformar o resultado de um CompletableFuture de forma independente do resultado de outras operações, retornando um novo CompletableFuture. Supondo que precisássemos formatar a string do preço com desconto de uma forma específica, poderíamos utilizar thenApply da seguinte maneira:\nprivate static void searchPricesWithDiscountAsyncNew() { long start = System.currentTimeMillis(); List\u003cCompletableFuture\u003cString\u003e\u003e stringFutures = STORES.stream() .map(store -\u003e CompletableFuture.supplyAsync(() -\u003e storeService.getQuote(store))) .map(cf -\u003e cf.thenCompose(quote -\u003e CompletableFuture.supplyAsync(() -\u003e storeService.applyDiscount(quote)))) .map(cf -\u003e cf.thenApply(discountedQuote -\u003e String.format(\"Discounted price: %s\", discountedQuote))) .toList(); stringFutures.stream() .map(stringFuture -\u003e stringFuture.join()) .forEach(System.out::println); long end = System.currentTimeMillis(); System.out.printf(\"[NEW ASYNC] Time elapsed: %d ms\\n\", end - start); } ThenApply vs ThenCompose Uma analogia para entendermos a diferença é a seguinte:\nthenApply é como Function.apply() enquanto thenCompose() é como compor funções thenApply é como um map e thenCompose é como um flatMap: public CompletableFuture\u003cUserInfo\u003e getUserInfo(userId) public CompletableFuture\u003cUserRating\u003e getUserRating(UserInfo) CompletableFuture\u003cCompletableFuture\u003cUserRating\u003e\u003e apply = userInfo.thenApply(this::getUserRating); CompletableFuture\u003cUserRating\u003e compose = userInfo.thenCompose(this::getUserRating); Ou seja, no geral usamos thenApply se temos uma função de mapeamento síncrona e thenCompose no caso oposto.\nYou would use thenCompose when you have an operation that returns a CompletionStage and thenApply when you have an operation\nThenApplyAsync, ThenComposeAsync Aqui, prefiro referenciar um conteúdo muito bem escrito encontrado aqui:\nImagine for a moment that you have an application that allows users to register themselves and upon registration they will receive a confirmation email to confirm their account.\nYou don’t want the user to be waiting for ever if the mail server is down or if it takes a long time to compose the email or perform additional checks.\nYou would then use thenApplyAsync to fire off the send email logic because it is not crucial to your system. A user can always go back and say “send me another email”\nstatic CompletionStage\u003cString\u003e register(String username) { throw new UnsupportedOperationException(); } static void sendConfirmationEmail(String username) { throw new UnsupportedOperationException(); } public static void main(String[] args) throws InterruptedException { register(\"user\").thenAcceptAsync(username -\u003e sendConfirmationEmail(username)); } Here your system will respond when the registration is complete but it will not wait for the email to be sent resulting in improved responsiveness of your system.\nAllOf e AnyOf Outro ponto importante ao trabalhar com CompletableFuture é o uso dos métodos estáticos allOf e anyOf, que são muito úteis para lidar com múltiplos CompletableFutures de forma eficiente.\nallOf O método allOf é usado quando você precisa esperar pela conclusão de todos os CompletableFutures em uma lista. Ele retorna um novo CompletableFuture que é concluído somente quando todos os CompletableFutures na lista são concluídos, independentemente de sucesso ou falha.\nPor exemplo, suponha que você tenha uma lista de CompletableFutures que representam operações assíncronas e deseja executar uma ação após a conclusão de todas elas:\nList\u003cCompletableFuture\u003cVoid\u003e\u003e futures = new ArrayList\u003c\u003e(); futures.add(CompletableFuture.runAsync(() -\u003e System.out.println(\"Task 1\"))); futures.add(CompletableFuture.runAsync(() -\u003e System.out.println(\"Task 2\"))); futures.add(CompletableFuture.runAsync(() -\u003e System.out.println(\"Task 3\"))); CompletableFuture\u003cVoid\u003e allFutures = CompletableFuture.allOf( futures.toArray(new CompletableFuture[0]) ); allFutures.thenRun(() -\u003e System.out.println(\"All tasks completed\"));` Neste exemplo, allFutures será concluído quando todas as tarefas assíncronas representadas pelos CompletableFutures na lista futures forem concluídas.\nanyOf Por outro lado, o método anyOf é usado quando você deseja esperar pela conclusão de apenas um dos CompletableFutures em uma lista. Ele retorna um novo CompletableFuture que é concluído assim que um dos CompletableFutures na lista é concluído, independentemente de sucesso ou falha.\nList\u003cCompletableFuture\u003cVoid\u003e\u003e futures = new ArrayList\u003c\u003e(); futures.add(CompletableFuture.runAsync(() -\u003e System.out.println(\"Task 1\"))); futures.add(CompletableFuture.runAsync(() -\u003e System.out.println(\"Task 2\"))); futures.add(CompletableFuture.runAsync(() -\u003e System.out.println(\"Task 3\"))); CompletableFuture\u003cObject\u003e anyFuture = CompletableFuture.anyOf( futures.toArray(new CompletableFuture[0]) ); anyFuture.thenAccept(result -\u003e System.out.println(\"One task completed\")); Neste exemplo, anyFuture será concluído assim que uma das tarefas assíncronas representadas pelos CompletableFutures na lista futures for concluída.\nReferências https://www.baeldung.com/java-completablefuture-threadpool#async-methods https://www.youtube.com/watch?v=ZKDgjM_x4bo\u0026list=PL62G310vn6nFIsOCC0H-C2infYgwm8SWW\u0026index=241\u0026ab_channel=DevDojo https://docs.oracle.com/en/java/javase/21/docs/api/java.base/java/util/concurrent/CompletableFuture.html https://dzone.com/articles/understanding-lazy-evaluation-in-java-streams\n","wordCount":"1624","inLanguage":"pt","image":"https://kaue.cat/%3Cimage%20path/url%3E","datePublished":"2024-04-05T20:18:37Z","dateModified":"2024-04-05T20:18:37Z","author":{"@type":"Person","name":"Me"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://kaue.cat/posts/concorrencia-java/completablefuture/"},"publisher":{"@type":"Organization","name":"Kaue Gatto","logo":{"@type":"ImageObject","url":"https://raw.githubusercontent.com/kauegatto/hugo-PaperMod/6aab706f2e2053433e33f8fd45dbec615f4d479f/images/favicon.ico"}}}</script></head><body class=dark id=top><script>localStorage.getItem("pref-theme")==="light"&&document.body.classList.remove("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://kaue.cat accesskey=h title="Home (Alt + H)"><img src=https://kaue.cat/apple-touch-icon.png alt aria-label=logo height=35>Home</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li>|</li><li><a href=https://kaue.cat/en/ title=English aria-label=English>En</a></li></ul></div></div><ul id=menu><li><a href=https://kaue.cat/archives title=Arquivo><span>Arquivo</span></a></li><li><a href=https://kaue.cat/search/ title=Buscar><span>Buscar</span></a></li><li><a href=https://kaue.cat/series/ title=Séries><span>Séries</span></a></li><li><a href=https://kaue.cat/tags/ title=Tags><span>Tags</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://kaue.cat>Início</a>&nbsp;»&nbsp;<a href=https://kaue.cat/posts/>Posts</a></div><h1 class=post-title>5. CompletableFuture - Dominando o Assíncrono em Java!</h1><div class=post-description>Sabemos como lidar com multiplas threads, evitar race conditions, entendemos pooling e sabemos o porquê devemos usar mecanismos assíncronos, agora, vamos entender a API moderna do JAVA para lidar com comportamentos assíncronos e paralelos.</div><div class=post-meta><span title='2024-04-05 20:18:37 +0000 UTC'>5 de abril , 2024</span>&nbsp;·&nbsp;8 minutos&nbsp;·&nbsp;1624 palavras&nbsp;·&nbsp;Me&nbsp;|&nbsp;<a href=https://github.com/kauegatto/kauedotcat/content/posts/concorrencia-java/completablefuture.md rel="noopener noreferrer" target=_blank>Sugerir Alterações</a></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Conteúdo</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#uso-com-streams>Uso com Streams!</a></li></ul><ul><li><a href=#thencompose>ThenCompose</a></li><li><a href=#thenapply>ThenApply</a><ul><li><a href=#thenapply-vs-thencompose>ThenApply vs ThenCompose</a></li><li><a href=#thenapplyasync-thencomposeasync>ThenApplyAsync, ThenComposeAsync</a></li></ul></li><li><a href=#allof-e-anyof>AllOf e AnyOf</a><ul><li><a href=#allof><code>allOf</code></a></li><li><a href=#anyof><code>anyOf</code></a></li></ul></li></ul></nav></div></details></div><div class=post-content><p>Seja bem vindo, esse daqui é o quinto de 6 posts sobre concorrência em Java. A série é focada em Java, mas esse post em especial apresenta conceitos relevantes para literalmente todas as linguagens e também não é uma leitura muito extensiva :).</p><p>Nosso roteiro é:</p><ol><li>Threads! Processando em Paralelo e Ganhando Throughput</li><li>Sincronização de Threads - DeadLocks, Zonas Críticas e Condições de Corrida</li><li>Concorrência, agora melhor - Classes Thread Safe</li><li>Executors, Thread Pools e Futures</li><li><strong>CompletableFuture</strong></li><li>Virtual Threads</li></ol><h1 id=introdução-e-join>Introdução e &ldquo;Join&rdquo;<a hidden class=anchor aria-hidden=true href=#introdução-e-join>#</a></h1><p>Suponha esse código:</p><p><em>StoreService</em></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kn>package</span> <span class=nn>DCompletableFuture</span><span class=o>;</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>java.util.concurrent.ExecutorService</span><span class=o>;</span>  
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>java.util.concurrent.Future</span><span class=o>;</span>  
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>java.util.concurrent.ThreadLocalRandom</span><span class=o>;</span>  
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>java.util.concurrent.TimeUnit</span><span class=o>;</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>StoreService</span> <span class=o>{</span>  
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>final</span> <span class=n>ExecutorService</span> <span class=n>executorService</span><span class=o>;</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=nf>StoreService</span><span class=o>(</span><span class=n>ExecutorService</span> <span class=n>executorService</span><span class=o>)</span> <span class=o>{</span>  
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=o>.</span><span class=na>executorService</span> <span class=o>=</span> <span class=n>executorService</span><span class=o>;</span>  
</span></span><span class=line><span class=cl>    <span class=o>}</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=n>Double</span> <span class=nf>getPricesSync</span><span class=o>()</span> <span class=kd>throws</span> <span class=n>InterruptedException</span> <span class=o>{</span>  
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>getPrices</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=n>Future</span><span class=o>&lt;</span><span class=n>Double</span><span class=o>&gt;</span> <span class=nf>getPricesAsync</span><span class=o>()</span> <span class=o>{</span>  
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>executorService</span><span class=o>.</span><span class=na>submit</span><span class=o>(</span><span class=k>this</span><span class=o>::</span><span class=n>getPrices</span><span class=o>);</span>  
</span></span><span class=line><span class=cl>    <span class=o>}</span>  
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>Double</span> <span class=nf>getPrices</span><span class=o>()</span> <span class=kd>throws</span> <span class=n>InterruptedException</span> <span class=o>{</span>  
</span></span><span class=line><span class=cl>        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;Getting prices...&#34;</span><span class=o>);</span>  
</span></span><span class=line><span class=cl>        <span class=n>TimeUnit</span><span class=o>.</span><span class=na>SECONDS</span><span class=o>.</span><span class=na>sleep</span><span class=o>(</span><span class=mi>1</span><span class=o>);</span>  
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>ThreadLocalRandom</span><span class=o>.</span><span class=na>current</span><span class=o>().</span><span class=na>nextDouble</span><span class=o>(</span><span class=mi>20</span><span class=o>,</span><span class=mi>200</span><span class=o>)*</span><span class=mi>3</span><span class=o>;</span>  
</span></span><span class=line><span class=cl>    <span class=o>}</span>  
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p><em>Main</em></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kn>package</span> <span class=nn>DCompletableFuture</span><span class=o>;</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>java.util.concurrent.ExecutorService</span><span class=o>;</span>  
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>java.util.concurrent.Executors</span><span class=o>;</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>Main</span> <span class=o>{</span>  
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=o>{</span>  
</span></span><span class=line><span class=cl>        <span class=n>var</span> <span class=n>ex</span> <span class=o>=</span> <span class=n>Executors</span><span class=o>.</span><span class=na>newFixedThreadPool</span><span class=o>(</span><span class=mi>2</span><span class=o>);</span>  
</span></span><span class=line><span class=cl>        <span class=n>ex</span><span class=o>.</span><span class=na>submit</span><span class=o>(</span><span class=n>Main</span><span class=o>::</span><span class=n>searchPricesAsync</span><span class=o>);</span>  
</span></span><span class=line><span class=cl>        <span class=n>ex</span><span class=o>.</span><span class=na>submit</span><span class=o>(</span><span class=n>Main</span><span class=o>::</span><span class=n>searchPricesSync</span><span class=o>);</span>  
</span></span><span class=line><span class=cl>    <span class=o>}</span>  
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>searchPricesSync</span><span class=o>(){</span>  
</span></span><span class=line><span class=cl>        <span class=kd>final</span> <span class=n>ExecutorService</span> <span class=n>ex</span> <span class=o>=</span> <span class=n>Executors</span><span class=o>.</span><span class=na>newFixedThreadPool</span><span class=o>(</span><span class=mi>3</span><span class=o>);</span>  
</span></span><span class=line><span class=cl>        <span class=n>StoreService</span> <span class=n>storeService</span> <span class=o>=</span> <span class=k>new</span> <span class=n>StoreService</span><span class=o>(</span><span class=n>ex</span><span class=o>);</span>  
</span></span><span class=line><span class=cl>        <span class=k>try</span> <span class=o>{</span>  
</span></span><span class=line><span class=cl>            <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>storeService</span><span class=o>.</span><span class=na>getPricesSync</span><span class=o>());</span>  
</span></span><span class=line><span class=cl>            <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>storeService</span><span class=o>.</span><span class=na>getPricesSync</span><span class=o>());</span>  
</span></span><span class=line><span class=cl>            <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>storeService</span><span class=o>.</span><span class=na>getPricesSync</span><span class=o>());</span>  
</span></span><span class=line><span class=cl>            <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>storeService</span><span class=o>.</span><span class=na>getPricesSync</span><span class=o>());</span>  
</span></span><span class=line><span class=cl>            <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>storeService</span><span class=o>.</span><span class=na>getPricesSync</span><span class=o>());</span>  
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>InterruptedException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>  
</span></span><span class=line><span class=cl>            <span class=n>e</span><span class=o>.</span><span class=na>printStackTrace</span><span class=o>();</span>  
</span></span><span class=line><span class=cl>        <span class=o>}</span>  
</span></span><span class=line><span class=cl>    <span class=o>}</span>  
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>searchPricesAsync</span><span class=o>()</span> <span class=o>{</span>  
</span></span><span class=line><span class=cl>        <span class=kd>final</span> <span class=n>ExecutorService</span> <span class=n>ex</span> <span class=o>=</span> <span class=n>Executors</span><span class=o>.</span><span class=na>newFixedThreadPool</span><span class=o>(</span><span class=mi>5</span><span class=o>);</span>  
</span></span><span class=line><span class=cl>        <span class=n>StoreService</span> <span class=n>storeService</span> <span class=o>=</span> <span class=k>new</span> <span class=n>StoreService</span><span class=o>(</span><span class=n>ex</span><span class=o>);</span>  
</span></span><span class=line><span class=cl>        <span class=k>try</span> <span class=o>{</span>  
</span></span><span class=line><span class=cl>            <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>storeService</span><span class=o>.</span><span class=na>getPricesAsync</span><span class=o>().</span><span class=na>get</span><span class=o>());</span>  
</span></span><span class=line><span class=cl>            <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>storeService</span><span class=o>.</span><span class=na>getPricesAsync</span><span class=o>().</span><span class=na>get</span><span class=o>());</span>  
</span></span><span class=line><span class=cl>            <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>storeService</span><span class=o>.</span><span class=na>getPricesAsync</span><span class=o>().</span><span class=na>get</span><span class=o>());</span>  
</span></span><span class=line><span class=cl>            <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>storeService</span><span class=o>.</span><span class=na>getPricesAsync</span><span class=o>().</span><span class=na>get</span><span class=o>());</span>  
</span></span><span class=line><span class=cl>            <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>storeService</span><span class=o>.</span><span class=na>getPricesAsync</span><span class=o>().</span><span class=na>get</span><span class=o>());</span>  
</span></span><span class=line><span class=cl>        <span class=o>}</span>  
</span></span><span class=line><span class=cl>        <span class=k>catch</span> <span class=o>(</span><span class=n>Exception</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>  
</span></span><span class=line><span class=cl>            <span class=n>e</span><span class=o>.</span><span class=na>printStackTrace</span><span class=o>();</span>  
</span></span><span class=line><span class=cl>        <span class=o>}</span>  
</span></span><span class=line><span class=cl>    <span class=o>}</span>  
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>No caso, estamos executando as operações de busca sync e async simultaneamente (uma em cada thread) e para cada uma delas, estamos submetendo as tarefas as threads e pegando seus resultados de maneira síncrona e sem usar todas nossas threads.</p><p>Pera, mas se getPricesAsync nos retorna uma Future, como isso é síncrono? Embora o processamento esteja sendo realizado paralelamente, nosso código fica realmente bloqueado, esperando pela resposta do <code>storeService.getPricesAsync()</code>, e ele só faz o pedido de busca do próximo código assíncrono quando o anterior termina, portanto, não estamos submetendo todas as tasks antes de esperá-las.</p><blockquote><p>[❗] <strong>Atenção</strong>
Note que aqui, o processameto síncrono é o problema pois estamos bloqueando a thread que realiza searchPricesAsync, fazendo com que ela só peça que a próxima execução aconteça quanto a anterior terminar. Mesmo que isso esteja sendo executado em uma thread auxiliar, estamos esperando a thread terminar seu trabalho para continuarmos o nosso.</p></blockquote><p>A solução seria dividir em duas partes:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>searchPricesAsync</span><span class=o>()</span> <span class=o>{</span>  
</span></span><span class=line><span class=cl>    <span class=kd>final</span> <span class=n>ExecutorService</span> <span class=n>ex</span> <span class=o>=</span> <span class=n>Executors</span><span class=o>.</span><span class=na>newFixedThreadPool</span><span class=o>(</span> <span class=mi>5</span><span class=o>);</span>  
</span></span><span class=line><span class=cl>    <span class=n>StoreService</span> <span class=n>storeService</span> <span class=o>=</span> <span class=k>new</span> <span class=n>StoreService</span><span class=o>(</span><span class=n>ex</span><span class=o>);</span>  
</span></span><span class=line><span class=cl>    <span class=n>Future</span><span class=o>&lt;</span><span class=n>Double</span><span class=o>&gt;</span> <span class=n>pricesAsyncFuture1</span> <span class=o>=</span> <span class=n>storeService</span><span class=o>.</span><span class=na>getPricesAsync</span><span class=o>();</span>  
</span></span><span class=line><span class=cl>    <span class=n>Future</span><span class=o>&lt;</span><span class=n>Double</span><span class=o>&gt;</span> <span class=n>pricesAsyncFuture2</span> <span class=o>=</span> <span class=n>storeService</span><span class=o>.</span><span class=na>getPricesAsync</span><span class=o>();</span>  
</span></span><span class=line><span class=cl>    <span class=n>Future</span><span class=o>&lt;</span><span class=n>Double</span><span class=o>&gt;</span> <span class=n>pricesAsyncFuture3</span> <span class=o>=</span> <span class=n>storeService</span><span class=o>.</span><span class=na>getPricesAsync</span><span class=o>();</span>  
</span></span><span class=line><span class=cl>    <span class=n>Future</span><span class=o>&lt;</span><span class=n>Double</span><span class=o>&gt;</span> <span class=n>pricesAsyncFuture4</span> <span class=o>=</span> <span class=n>storeService</span><span class=o>.</span><span class=na>getPricesAsync</span><span class=o>();</span>  
</span></span><span class=line><span class=cl>    <span class=n>Future</span><span class=o>&lt;</span><span class=n>Double</span><span class=o>&gt;</span> <span class=n>pricesAsyncFuture5</span> <span class=o>=</span> <span class=n>storeService</span><span class=o>.</span><span class=na>getPricesAsync</span><span class=o>();</span>  
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=o>{</span>  
</span></span><span class=line><span class=cl>        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>pricesAsyncFuture1</span><span class=o>.</span><span class=na>get</span><span class=o>());</span>  
</span></span><span class=line><span class=cl>        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>pricesAsyncFuture2</span><span class=o>.</span><span class=na>get</span><span class=o>());</span>  
</span></span><span class=line><span class=cl>        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>pricesAsyncFuture3</span><span class=o>.</span><span class=na>get</span><span class=o>());</span>  
</span></span><span class=line><span class=cl>        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>pricesAsyncFuture4</span><span class=o>.</span><span class=na>get</span><span class=o>());</span>  
</span></span><span class=line><span class=cl>        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>pricesAsyncFuture5</span><span class=o>.</span><span class=na>get</span><span class=o>());</span>  
</span></span><span class=line><span class=cl>    <span class=o>}</span>  
</span></span><span class=line><span class=cl>    <span class=k>catch</span> <span class=o>(</span><span class=n>Exception</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>  
</span></span><span class=line><span class=cl>        <span class=n>e</span><span class=o>.</span><span class=na>printStackTrace</span><span class=o>();</span>  
</span></span><span class=line><span class=cl>    <span class=o>}</span>  
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>E agora sim temos essa belezinha de resultado:</p><pre tabindex=0><code>Getting prices... - pool-2-thread-4
Getting prices... - pool-2-thread-3
Getting prices... - pool-2-thread-1
Getting prices... - pool-2-thread-2
Getting prices... - pool-1-thread-2
Getting prices... - pool-2-thread-5
</code></pre><p>Apesar disso, o código não é tão bonito assim, né? Vamos ver uma evolução dos <code>Futures</code> - <code>CompletableFutures</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=n>CompletableFuture</span><span class=o>&lt;</span><span class=n>Double</span><span class=o>&gt;</span> <span class=nf>getPricesWithCompletableFuture</span><span class=o>()</span> <span class=o>{</span>  
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>CompletableFuture</span><span class=o>.</span><span class=na>supplyAsync</span><span class=o>(()</span> <span class=o>-&gt;</span> <span class=o>{</span>  
</span></span><span class=line><span class=cl>        <span class=k>try</span> <span class=o>{</span>  
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>getPrices</span><span class=o>();</span>  
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>InterruptedException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>  
</span></span><span class=line><span class=cl>            <span class=k>throw</span> <span class=k>new</span> <span class=n>RuntimeException</span><span class=o>(</span><span class=n>e</span><span class=o>);</span>  
</span></span><span class=line><span class=cl>        <span class=o>}</span>  
</span></span><span class=line><span class=cl>    <span class=o>});</span>  
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>Aqui, note que só temos esse try porque getPricesRealmente pode jogar uma InterruptedException.</p><blockquote><p>Perceba também que não passamos o executor para o supplyAsync (poderíamos), mas ele possuí um executor &ldquo;nativo&rdquo;:
<strong>According to the <a href=https://docs.oracle.com/en/java/javase/21/docs/api/java.base/java/util/concurrent/CompletableFuture.html>official documentation</a>, if we use the async methods without explicitly providing an <em>Executor</em>, the functions will be executed using <em>ForkJoinPool.commonPool().</em></strong> Therefore, if we run the code snippet, we should expect to see one of the common <em>ForkJoinPool</em> workers: in my case, “<em>ForkJoinPool.commonPool-worker-1″.</em> - <a href=https://www.baeldung.com/java-completablefuture-threadpool#async-methods>https://www.baeldung.com/java-completablefuture-threadpool#async-methods</a></p></blockquote><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>searchPricesAsync</span><span class=o>()</span> <span class=o>{</span>  
</span></span><span class=line><span class=cl>    <span class=kd>final</span> <span class=n>ExecutorService</span> <span class=n>ex</span> <span class=o>=</span> <span class=n>Executors</span><span class=o>.</span><span class=na>newFixedThreadPool</span><span class=o>(</span> <span class=mi>5</span><span class=o>);</span>  
</span></span><span class=line><span class=cl>    <span class=n>StoreService</span> <span class=n>storeService</span> <span class=o>=</span> <span class=k>new</span> <span class=n>StoreService</span><span class=o>(</span><span class=n>ex</span><span class=o>);</span>  
</span></span><span class=line><span class=cl>    <span class=n>CompletableFuture</span><span class=o>&lt;</span><span class=n>Double</span><span class=o>&gt;</span> <span class=n>pricesAsyncCompletableFuture1</span> <span class=o>=</span> <span class=n>storeService</span><span class=o>.</span><span class=na>getPricesWithCompletableFuture</span><span class=o>();</span>  
</span></span><span class=line><span class=cl>    <span class=n>CompletableFuture</span><span class=o>&lt;</span><span class=n>Double</span><span class=o>&gt;</span> <span class=n>pricesAsyncCompletableFuture2</span> <span class=o>=</span> <span class=n>storeService</span><span class=o>.</span><span class=na>getPricesWithCompletableFuture</span><span class=o>();</span>  
</span></span><span class=line><span class=cl>    <span class=n>CompletableFuture</span><span class=o>&lt;</span><span class=n>Double</span><span class=o>&gt;</span> <span class=n>pricesAsyncCompletableFuture3</span> <span class=o>=</span> <span class=n>storeService</span><span class=o>.</span><span class=na>getPricesWithCompletableFuture</span><span class=o>();</span>  
</span></span><span class=line><span class=cl>    <span class=n>CompletableFuture</span><span class=o>&lt;</span><span class=n>Double</span><span class=o>&gt;</span> <span class=n>pricesAsyncCompletableFuture4</span> <span class=o>=</span> <span class=n>storeService</span><span class=o>.</span><span class=na>getPricesWithCompletableFuture</span><span class=o>();</span>  
</span></span><span class=line><span class=cl>    <span class=n>CompletableFuture</span><span class=o>&lt;</span><span class=n>Double</span><span class=o>&gt;</span> <span class=n>pricesAsyncCompletableFuture5</span> <span class=o>=</span> <span class=n>storeService</span><span class=o>.</span><span class=na>getPricesWithCompletableFuture</span><span class=o>();</span>  
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>pricesAsyncCompletableFuture1</span><span class=o>.</span><span class=na>join</span><span class=o>());</span>  
</span></span><span class=line><span class=cl>    <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>pricesAsyncCompletableFuture2</span><span class=o>.</span><span class=na>join</span><span class=o>());</span>  
</span></span><span class=line><span class=cl>    <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>pricesAsyncCompletableFuture3</span><span class=o>.</span><span class=na>join</span><span class=o>());</span>  
</span></span><span class=line><span class=cl>    <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>pricesAsyncCompletableFuture4</span><span class=o>.</span><span class=na>join</span><span class=o>());</span>  
</span></span><span class=line><span class=cl>    <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>pricesAsyncCompletableFuture5</span><span class=o>.</span><span class=na>join</span><span class=o>());</span>  
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>Aqui, note que já <strong>não precisamos usar try/catch nos <em>joins</em></strong>, equivalente ao <em>.get()</em> do <em>CompletableFuture</em></p><h2 id=uso-com-streams>Uso com Streams!<a hidden class=anchor aria-hidden=true href=#uso-com-streams>#</a></h2><blockquote><p>[☣️] <strong>Cuidado com Streams!</strong>
Ao usarmos CompletableFuture com streams, precisamos ter um cuidado, nossas streams não podem iterar a lista de CompletableFutures usando <code>join</code>, senão, voltamos ao cenário do processamento síncrono, o correto é retornar essa stream em duas partes diferentes, uma que realiza o supply das tarefas para as threads e outra que realmente executa o join.</p></blockquote><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl>  
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>Main</span> <span class=o>{</span>  
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=n>StoreServiceSync</span> <span class=n>storeService</span> <span class=o>=</span> <span class=k>new</span> <span class=n>StoreServiceSync</span><span class=o>();</span>  
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=n>Set</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span> <span class=n>STORES</span> <span class=o>=</span>  <span class=n>Set</span><span class=o>.</span><span class=na>of</span><span class=o>(</span><span class=s>&#34;BestPrice&#34;</span><span class=o>,</span> <span class=s>&#34;LetsSaveBig&#34;</span><span class=o>,</span> <span class=s>&#34;MyFavoriteShop&#34;</span><span class=o>,</span> <span class=s>&#34;BuyItAll&#34;</span><span class=o>);</span>  
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=o>{</span>  
</span></span><span class=line><span class=cl>        <span class=n>searchPricesWithDiscount</span><span class=o>();</span>  
</span></span><span class=line><span class=cl>        <span class=n>searchPricesWithDiscountAsync</span><span class=o>();</span>  
</span></span><span class=line><span class=cl>    <span class=o>}</span>  
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>searchPricesWithDiscount</span><span class=o>(){</span>  
</span></span><span class=line><span class=cl>        <span class=kt>long</span> <span class=n>start</span> <span class=o>=</span> <span class=n>System</span><span class=o>.</span><span class=na>currentTimeMillis</span><span class=o>();</span>  
</span></span><span class=line><span class=cl>        <span class=n>STORES</span><span class=o>.</span><span class=na>stream</span><span class=o>()</span>  
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>map</span><span class=o>(</span><span class=n>store</span> <span class=o>-&gt;</span> <span class=n>storeService</span><span class=o>.</span><span class=na>getQuote</span><span class=o>(</span><span class=n>store</span><span class=o>))</span>  
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>peek</span><span class=o>(</span><span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>::</span><span class=n>println</span><span class=o>)</span>  
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>map</span><span class=o>(</span><span class=n>quote</span> <span class=o>-&gt;</span> <span class=n>storeService</span><span class=o>.</span><span class=na>applyDiscount</span><span class=o>(</span><span class=n>quote</span><span class=o>))</span>  
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>forEach</span><span class=o>(</span><span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>::</span><span class=n>println</span><span class=o>);</span>  
</span></span><span class=line><span class=cl>        <span class=kt>long</span> <span class=n>end</span> <span class=o>=</span> <span class=n>System</span><span class=o>.</span><span class=na>currentTimeMillis</span><span class=o>();</span>  
</span></span><span class=line><span class=cl>        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>printf</span><span class=o>(</span><span class=s>&#34;[SYNC] Time elapsed: %d ms&#34;</span><span class=o>,</span> <span class=n>end</span> <span class=o>-</span> <span class=n>start</span><span class=o>);</span>  
</span></span><span class=line><span class=cl>    <span class=o>}</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>searchPricesWithDiscountAsync</span><span class=o>(){</span>  
</span></span><span class=line><span class=cl>        <span class=kt>long</span> <span class=n>start</span> <span class=o>=</span> <span class=n>System</span><span class=o>.</span><span class=na>currentTimeMillis</span><span class=o>();</span>  
</span></span><span class=line><span class=cl>        <span class=n>List</span><span class=o>&lt;</span><span class=n>CompletableFuture</span><span class=o>&lt;</span><span class=n>Quote</span><span class=o>&gt;&gt;</span> <span class=n>quotesFutures</span> <span class=o>=</span> <span class=n>STORES</span><span class=o>.</span><span class=na>stream</span><span class=o>()</span>  
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>map</span><span class=o>(</span><span class=n>store</span> <span class=o>-&gt;</span> <span class=n>CompletableFuture</span><span class=o>.</span><span class=na>supplyAsync</span><span class=o>(()</span> <span class=o>-&gt;</span> <span class=n>storeService</span><span class=o>.</span><span class=na>getQuote</span><span class=o>(</span><span class=n>store</span><span class=o>)))</span>  
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>toList</span><span class=o>();</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>        <span class=n>List</span><span class=o>&lt;</span><span class=n>Quote</span><span class=o>&gt;</span> <span class=n>quotes</span> <span class=o>=</span> <span class=n>quotesFutures</span><span class=o>.</span><span class=na>stream</span><span class=o>()</span>  
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>map</span><span class=o>(</span><span class=n>quoteCompletableFuture</span> <span class=o>-&gt;</span> <span class=n>quoteCompletableFuture</span><span class=o>.</span><span class=na>join</span><span class=o>())</span>  
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>peek</span><span class=o>(</span><span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>::</span><span class=n>println</span><span class=o>)</span>  
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>toList</span><span class=o>();</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>        <span class=n>List</span><span class=o>&lt;</span><span class=n>CompletableFuture</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;&gt;</span> <span class=n>pricesFutures</span> <span class=o>=</span> <span class=n>quotes</span><span class=o>.</span><span class=na>stream</span><span class=o>()</span>  
</span></span><span class=line><span class=cl>            <span class=o>.</span><span class=na>map</span><span class=o>(</span><span class=n>currQuote</span> <span class=o>-&gt;</span> <span class=n>CompletableFuture</span><span class=o>.</span><span class=na>supplyAsync</span><span class=o>(()</span> <span class=o>-&gt;</span> <span class=n>storeService</span><span class=o>.</span><span class=na>applyDiscount</span><span class=o>(</span><span class=n>currQuote</span><span class=o>)))</span>  
</span></span><span class=line><span class=cl>            <span class=o>.</span><span class=na>toList</span><span class=o>();</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>        <span class=n>List</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span> <span class=n>prices</span> <span class=o>=</span> <span class=n>pricesFutures</span>  
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>stream</span><span class=o>()</span>  
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>map</span><span class=o>(</span><span class=n>priceFuture</span> <span class=o>-&gt;</span> <span class=n>priceFuture</span><span class=o>.</span><span class=na>join</span><span class=o>())</span>  
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>peek</span><span class=o>(</span><span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>::</span><span class=n>println</span><span class=o>)</span>  
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>toList</span><span class=o>();</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>        <span class=kt>long</span> <span class=n>end</span> <span class=o>=</span> <span class=n>System</span><span class=o>.</span><span class=na>currentTimeMillis</span><span class=o>();</span>  
</span></span><span class=line><span class=cl>        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>printf</span><span class=o>(</span><span class=s>&#34;[ASYNC] Time elapsed: %d ms&#34;</span><span class=o>,</span> <span class=n>end</span> <span class=o>-</span> <span class=n>start</span><span class=o>);</span>  
</span></span><span class=line><span class=cl>    <span class=o>}</span>  
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>Aqui, note que tanto as operações de <code>getQuote</code> quanto as de <code>applyDiscount</code> são assíncronas, portanto, elas foram divididas em duas partes cada
Resultados:</p><pre tabindex=0><code>Quote[store=MyFavoriteShop, price=60.0, discountCode=GOLD]
MyFavoriteShop price is 54.00
Quote[store=BuyItAll, price=430.0, discountCode=DIAMOND]
BuyItAll price is 344.00
Quote[store=LetsSaveBig, price=1300.0, discountCode=DIAMOND]
LetsSaveBig price is 1040.00
Quote[store=BestPrice, price=150.0, discountCode=SILVER]
BestPrice price is 142.50
[SYNC] Time elapsed: 16031
</code></pre><pre tabindex=0><code>Quote[store=MyFavoriteShop, price=4430.0, discountCode=DIAMOND]
Quote[store=BuyItAll, price=180.0, discountCode=DIAMOND]
Quote[store=LetsSaveBig, price=690.0, discountCode=PLATINUM]
Quote[store=BestPrice, price=1670.0, discountCode=SILVER]
MyFavoriteShop price is 3544.00
BuyItAll price is 144.00
LetsSaveBig price is 586.50
BestPrice price is 1586.50
[ASYNC] Time elapsed: 4014 ms
</code></pre><p>O código funcionou bem, mas está bem verboso, vamos melhorá-lo:</p><h1 id=encadeando-chamadas>Encadeando chamadas:<a hidden class=anchor aria-hidden=true href=#encadeando-chamadas>#</a></h1><h2 id=thencompose>ThenCompose<a hidden class=anchor aria-hidden=true href=#thencompose>#</a></h2><p>O método <code>thenCompose</code> é utilizado para encadear operações de forma que a segunda operação dependa do resultado da primeira, <strong>retornando um novo <code>CompletableFuture</code></strong>. No exemplo a seguir, utilizamos <code>thenCompose</code> para aplicar o desconto após obter a cotação de forma assíncrona:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>searchPricesWithDiscountAsyncNew</span><span class=o>(){</span>  
</span></span><span class=line><span class=cl>    <span class=kt>long</span> <span class=n>start</span> <span class=o>=</span> <span class=n>System</span><span class=o>.</span><span class=na>currentTimeMillis</span><span class=o>();</span>  
</span></span><span class=line><span class=cl>    <span class=n>List</span><span class=o>&lt;</span><span class=n>CompletableFuture</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;&gt;</span> <span class=n>stringFutures</span> <span class=o>=</span> <span class=n>STORES</span><span class=o>.</span><span class=na>stream</span><span class=o>()</span>  
</span></span><span class=line><span class=cl>            <span class=o>.</span><span class=na>map</span><span class=o>(</span><span class=n>store</span> <span class=o>-&gt;</span> <span class=n>CompletableFuture</span><span class=o>.</span><span class=na>supplyAsync</span><span class=o>(()</span> <span class=o>-&gt;</span> <span class=n>storeService</span><span class=o>.</span><span class=na>getQuote</span><span class=o>(</span><span class=n>store</span><span class=o>)))</span>  
</span></span><span class=line><span class=cl>            <span class=o>.</span><span class=na>map</span><span class=o>(</span><span class=n>cf</span> <span class=o>-&gt;</span> <span class=n>cf</span><span class=o>.</span><span class=na>thenCompose</span><span class=o>(</span><span class=n>quote</span> <span class=o>-&gt;</span> <span class=n>CompletableFuture</span><span class=o>.</span><span class=na>supplyAsync</span><span class=o>(()</span> <span class=o>-&gt;</span> <span class=n>storeService</span><span class=o>.</span><span class=na>applyDiscount</span><span class=o>(</span><span class=n>quote</span><span class=o>))))</span>  
</span></span><span class=line><span class=cl>            <span class=o>.</span><span class=na>toList</span><span class=o>();</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>    <span class=n>stringFutures</span><span class=o>.</span><span class=na>stream</span><span class=o>()</span>  
</span></span><span class=line><span class=cl>            <span class=o>.</span><span class=na>map</span><span class=o>(</span><span class=n>stringFuture</span> <span class=o>-&gt;</span> <span class=n>stringFuture</span><span class=o>.</span><span class=na>join</span><span class=o>())</span>  
</span></span><span class=line><span class=cl>            <span class=o>.</span><span class=na>forEach</span><span class=o>(</span><span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>::</span><span class=n>println</span><span class=o>);</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>    <span class=kt>long</span> <span class=n>end</span> <span class=o>=</span> <span class=n>System</span><span class=o>.</span><span class=na>currentTimeMillis</span><span class=o>();</span>  
</span></span><span class=line><span class=cl>    <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>printf</span><span class=o>(</span><span class=s>&#34;[NEW ASYNC] Time elapsed: %d ms\n&#34;</span><span class=o>,</span> <span class=n>end</span> <span class=o>-</span> <span class=n>start</span><span class=o>);</span>  
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>Neste exemplo, <code>thenCompose</code> é utilizado para encadear a obtenção da cotação (<code>getQuote</code>) com a aplicação do desconto (<code>applyDiscount</code>) de forma assíncrona, resultando em um código mais conciso e legível.</p><h2 id=thenapply>ThenApply<a hidden class=anchor aria-hidden=true href=#thenapply>#</a></h2><p>O método <code>thenApply</code> é utilizado quando queremos transformar o resultado de um <code>CompletableFuture</code> de forma independente do resultado de outras operações, retornando um novo <code>CompletableFuture</code>. Supondo que precisássemos formatar a string do preço com desconto de uma forma específica, poderíamos utilizar <code>thenApply</code> da seguinte maneira:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>searchPricesWithDiscountAsyncNew</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>long</span> <span class=n>start</span> <span class=o>=</span> <span class=n>System</span><span class=o>.</span><span class=na>currentTimeMillis</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>List</span><span class=o>&lt;</span><span class=n>CompletableFuture</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;&gt;</span> <span class=n>stringFutures</span> <span class=o>=</span> <span class=n>STORES</span><span class=o>.</span><span class=na>stream</span><span class=o>()</span>
</span></span><span class=line><span class=cl>            <span class=o>.</span><span class=na>map</span><span class=o>(</span><span class=n>store</span> <span class=o>-&gt;</span> <span class=n>CompletableFuture</span><span class=o>.</span><span class=na>supplyAsync</span><span class=o>(()</span> <span class=o>-&gt;</span> <span class=n>storeService</span><span class=o>.</span><span class=na>getQuote</span><span class=o>(</span><span class=n>store</span><span class=o>)))</span>
</span></span><span class=line><span class=cl>            <span class=o>.</span><span class=na>map</span><span class=o>(</span><span class=n>cf</span> <span class=o>-&gt;</span> <span class=n>cf</span><span class=o>.</span><span class=na>thenCompose</span><span class=o>(</span><span class=n>quote</span> <span class=o>-&gt;</span> <span class=n>CompletableFuture</span><span class=o>.</span><span class=na>supplyAsync</span><span class=o>(()</span> <span class=o>-&gt;</span> <span class=n>storeService</span><span class=o>.</span><span class=na>applyDiscount</span><span class=o>(</span><span class=n>quote</span><span class=o>))))</span>
</span></span><span class=line><span class=cl>            <span class=o>.</span><span class=na>map</span><span class=o>(</span><span class=n>cf</span> <span class=o>-&gt;</span> <span class=n>cf</span><span class=o>.</span><span class=na>thenApply</span><span class=o>(</span><span class=n>discountedQuote</span> <span class=o>-&gt;</span> <span class=n>String</span><span class=o>.</span><span class=na>format</span><span class=o>(</span><span class=s>&#34;Discounted price: %s&#34;</span><span class=o>,</span> <span class=n>discountedQuote</span><span class=o>)))</span>
</span></span><span class=line><span class=cl>            <span class=o>.</span><span class=na>toList</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>stringFutures</span><span class=o>.</span><span class=na>stream</span><span class=o>()</span>
</span></span><span class=line><span class=cl>            <span class=o>.</span><span class=na>map</span><span class=o>(</span><span class=n>stringFuture</span> <span class=o>-&gt;</span> <span class=n>stringFuture</span><span class=o>.</span><span class=na>join</span><span class=o>())</span>
</span></span><span class=line><span class=cl>            <span class=o>.</span><span class=na>forEach</span><span class=o>(</span><span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>::</span><span class=n>println</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>long</span> <span class=n>end</span> <span class=o>=</span> <span class=n>System</span><span class=o>.</span><span class=na>currentTimeMillis</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>printf</span><span class=o>(</span><span class=s>&#34;[NEW ASYNC] Time elapsed: %d ms\n&#34;</span><span class=o>,</span> <span class=n>end</span> <span class=o>-</span> <span class=n>start</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><h3 id=thenapply-vs-thencompose>ThenApply vs ThenCompose<a hidden class=anchor aria-hidden=true href=#thenapply-vs-thencompose>#</a></h3><p>Uma analogia para entendermos a diferença é a seguinte:</p><ul><li><code>thenApply</code> é como Function.apply() enquanto <code>thenCompose()</code> é como compor funções</li><li><code>thenApply</code> é como um <code>map</code> e <code>thenCompose</code> é como um <code>flatMap</code>:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=n>CompletableFuture</span><span class=o>&lt;</span><span class=n>UserInfo</span><span class=o>&gt;</span> <span class=nf>getUserInfo</span><span class=o>(</span><span class=n>userId</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=n>CompletableFuture</span><span class=o>&lt;</span><span class=n>UserRating</span><span class=o>&gt;</span> <span class=nf>getUserRating</span><span class=o>(</span><span class=n>UserInfo</span><span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>CompletableFuture</span><span class=o>&lt;</span><span class=n>CompletableFuture</span><span class=o>&lt;</span><span class=n>UserRating</span><span class=o>&gt;&gt;</span> <span class=n>apply</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>    <span class=n>userInfo</span><span class=o>.</span><span class=na>thenApply</span><span class=o>(</span><span class=k>this</span><span class=o>::</span><span class=n>getUserRating</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>CompletableFuture</span><span class=o>&lt;</span><span class=n>UserRating</span><span class=o>&gt;</span> <span class=n>compose</span>  <span class=o>=</span>
</span></span><span class=line><span class=cl>    <span class=n>userInfo</span><span class=o>.</span><span class=na>thenCompose</span><span class=o>(</span><span class=k>this</span><span class=o>::</span><span class=n>getUserRating</span><span class=o>);</span>
</span></span></code></pre></div><p>Ou seja, no geral usamos thenApply se temos uma função de mapeamento síncrona e thenCompose no caso oposto.</p><blockquote><p>You would use <code>thenCompose</code> when you have an operation that returns a <code>CompletionStage</code> and <code>thenApply</code> when you have an operation</p></blockquote><h3 id=thenapplyasync-thencomposeasync>ThenApplyAsync, ThenComposeAsync<a hidden class=anchor aria-hidden=true href=#thenapplyasync-thencomposeasync>#</a></h3><p>Aqui, prefiro referenciar um conteúdo muito bem escrito encontrado <a href=https://stackoverflow.com/a/46063193>aqui</a>:</p><p>Imagine for a moment that you have an application that allows users to register themselves and upon registration they will receive a confirmation email to confirm their account.</p><p>You don&rsquo;t want the user to be waiting for ever if the mail server is down or if it takes a long time to compose the email or perform additional checks.</p><p>You would then use <code>thenApplyAsync</code> to fire off the send email logic because it is not crucial to your system. A user can always go back and say &ldquo;send me another email&rdquo;</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>static</span> <span class=n>CompletionStage</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span> <span class=nf>register</span><span class=o>(</span><span class=n>String</span> <span class=n>username</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>throw</span> <span class=k>new</span> <span class=n>UnsupportedOperationException</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>static</span> <span class=kt>void</span> <span class=nf>sendConfirmationEmail</span><span class=o>(</span><span class=n>String</span> <span class=n>username</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>throw</span> <span class=k>new</span> <span class=n>UnsupportedOperationException</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>InterruptedException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>register</span><span class=o>(</span><span class=s>&#34;user&#34;</span><span class=o>).</span><span class=na>thenAcceptAsync</span><span class=o>(</span><span class=n>username</span> <span class=o>-&gt;</span> <span class=n>sendConfirmationEmail</span><span class=o>(</span><span class=n>username</span><span class=o>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>Here your system will respond when the registration is complete but it will not wait for the email to be sent resulting in improved responsiveness of your system.</p><h2 id=allof-e-anyof>AllOf e AnyOf<a hidden class=anchor aria-hidden=true href=#allof-e-anyof>#</a></h2><p>Outro ponto importante ao trabalhar com <code>CompletableFuture</code> é o uso dos métodos estáticos <code>allOf</code> e <code>anyOf</code>, que são muito úteis para lidar com múltiplos <code>CompletableFutures</code> de forma eficiente.</p><h3 id=allof><code>allOf</code><a hidden class=anchor aria-hidden=true href=#allof>#</a></h3><p>O método <code>allOf</code> é usado quando você precisa esperar pela conclusão de todos os <code>CompletableFutures</code> em uma lista. Ele retorna um <strong>novo</strong> <code>CompletableFuture</code> que é concluído somente quando todos os <code>CompletableFutures</code> na lista são concluídos, independentemente de sucesso ou falha.</p><p>Por exemplo, suponha que você tenha uma lista de <code>CompletableFutures</code> que representam operações assíncronas e deseja executar uma ação após a conclusão de todas elas:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>List</span><span class=o>&lt;</span><span class=n>CompletableFuture</span><span class=o>&lt;</span><span class=n>Void</span><span class=o>&gt;&gt;</span> <span class=n>futures</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ArrayList</span><span class=o>&lt;&gt;();</span> <span class=n>futures</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=n>CompletableFuture</span><span class=o>.</span><span class=na>runAsync</span><span class=o>(()</span> <span class=o>-&gt;</span> <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;Task 1&#34;</span><span class=o>)));</span> <span class=n>futures</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=n>CompletableFuture</span><span class=o>.</span><span class=na>runAsync</span><span class=o>(()</span> <span class=o>-&gt;</span> <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;Task 2&#34;</span><span class=o>)));</span> <span class=n>futures</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=n>CompletableFuture</span><span class=o>.</span><span class=na>runAsync</span><span class=o>(()</span> <span class=o>-&gt;</span> <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;Task 3&#34;</span><span class=o>)));</span>  <span class=n>CompletableFuture</span><span class=o>&lt;</span><span class=n>Void</span><span class=o>&gt;</span> <span class=n>allFutures</span> <span class=o>=</span> <span class=n>CompletableFuture</span><span class=o>.</span><span class=na>allOf</span><span class=o>(</span>         <span class=n>futures</span><span class=o>.</span><span class=na>toArray</span><span class=o>(</span><span class=k>new</span> <span class=n>CompletableFuture</span><span class=o>[</span><span class=mi>0</span><span class=o>])</span> <span class=o>);</span>  <span class=n>allFutures</span><span class=o>.</span><span class=na>thenRun</span><span class=o>(()</span> <span class=o>-&gt;</span> <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;All tasks completed&#34;</span><span class=o>));</span><span class=err>`</span>
</span></span></code></pre></div><p>Neste exemplo, <code>allFutures</code> será concluído quando todas as tarefas assíncronas representadas pelos <code>CompletableFutures</code> na lista <code>futures</code> forem concluídas.</p><h3 id=anyof><code>anyOf</code><a hidden class=anchor aria-hidden=true href=#anyof>#</a></h3><p>Por outro lado, o método <code>anyOf</code> é usado quando você deseja esperar pela conclusão de apenas um dos <code>CompletableFutures</code> em uma lista. Ele retorna um novo <code>CompletableFuture</code> que é concluído assim que um dos <code>CompletableFutures</code> na lista é concluído, independentemente de sucesso ou falha.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>List</span><span class=o>&lt;</span><span class=n>CompletableFuture</span><span class=o>&lt;</span><span class=n>Void</span><span class=o>&gt;&gt;</span> <span class=n>futures</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ArrayList</span><span class=o>&lt;&gt;();</span> <span class=n>futures</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=n>CompletableFuture</span><span class=o>.</span><span class=na>runAsync</span><span class=o>(()</span> <span class=o>-&gt;</span> <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;Task 1&#34;</span><span class=o>)));</span> <span class=n>futures</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=n>CompletableFuture</span><span class=o>.</span><span class=na>runAsync</span><span class=o>(()</span> <span class=o>-&gt;</span> <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;Task 2&#34;</span><span class=o>)));</span> <span class=n>futures</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=n>CompletableFuture</span><span class=o>.</span><span class=na>runAsync</span><span class=o>(()</span> <span class=o>-&gt;</span> <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;Task 3&#34;</span><span class=o>)));</span>  
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl><span class=n>CompletableFuture</span><span class=o>&lt;</span><span class=n>Object</span><span class=o>&gt;</span> <span class=n>anyFuture</span> <span class=o>=</span> <span class=n>CompletableFuture</span><span class=o>.</span><span class=na>anyOf</span><span class=o>(</span> <span class=n>futures</span><span class=o>.</span><span class=na>toArray</span><span class=o>(</span><span class=k>new</span> <span class=n>CompletableFuture</span><span class=o>[</span><span class=mi>0</span><span class=o>])</span> <span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>anyFuture</span><span class=o>.</span><span class=na>thenAccept</span><span class=o>(</span><span class=n>result</span> <span class=o>-&gt;</span> <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;One task completed&#34;</span><span class=o>));</span>
</span></span></code></pre></div><p>Neste exemplo, <code>anyFuture</code> será concluído assim que uma das tarefas assíncronas representadas pelos <code>CompletableFutures</code> na lista <code>futures</code> for concluída.</p><h1 id=referências>Referências<a hidden class=anchor aria-hidden=true href=#referências>#</a></h1><p><a href=https://www.baeldung.com/java-completablefuture-threadpool#async-methods>https://www.baeldung.com/java-completablefuture-threadpool#async-methods</a>
<a href="https://www.youtube.com/watch?v=ZKDgjM_x4bo&list=PL62G310vn6nFIsOCC0H-C2infYgwm8SWW&index=241&ab_channel=DevDojo">https://www.youtube.com/watch?v=ZKDgjM_x4bo&list=PL62G310vn6nFIsOCC0H-C2infYgwm8SWW&index=241&ab_channel=DevDojo</a>
<a href=https://docs.oracle.com/en/java/javase/21/docs/api/java.base/java/util/concurrent/CompletableFuture.html>https://docs.oracle.com/en/java/javase/21/docs/api/java.base/java/util/concurrent/CompletableFuture.html</a>
<a href=https://dzone.com/articles/understanding-lazy-evaluation-in-java-streams>https://dzone.com/articles/understanding-lazy-evaluation-in-java-streams</a></p></div><footer class=post-footer><ul class=post-tags><li><a href=https://kaue.cat/tags/concorrencia/>Concorrencia</a></li><li><a href=https://kaue.cat/tags/java/>JAVA</a></li></ul><nav class=paginav><a class=prev href=https://kaue.cat/posts/concorrencia-java/virtual-threads/><span class=title>« Página Anterior</span><br><span>6. Virtual Threads em Java! Fazendo a sua aplicação voar!</span></a>
<a class=next href=https://kaue.cat/posts/concorrencia-java/executors-e-threadpools/><span class=title>Próxima Página »</span><br><span>4. Executors, Thread Pools e Futures em Java</span></a></nav><div class=share-buttons><a>Compartilhar:</a><br><a target=_blank rel="noopener noreferrer" aria-label="share 5. CompletableFuture - Dominando o Assíncrono em Java! on x" href="https://x.com/intent/tweet/?text=5.%20CompletableFuture%20-%20Dominando%20o%20Ass%c3%adncrono%20em%20Java%21&url=https%3a%2f%2fkaue.cat%2fposts%2fconcorrencia-java%2fcompletablefuture%2f&hashtags=Concorrencia%2cJAVA"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share 5. CompletableFuture - Dominando o Assíncrono em Java! on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fkaue.cat%2fposts%2fconcorrencia-java%2fcompletablefuture%2f&title=5.%20CompletableFuture%20-%20Dominando%20o%20Ass%c3%adncrono%20em%20Java%21&summary=5.%20CompletableFuture%20-%20Dominando%20o%20Ass%c3%adncrono%20em%20Java%21&source=https%3a%2f%2fkaue.cat%2fposts%2fconcorrencia-java%2fcompletablefuture%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share 5. CompletableFuture - Dominando o Assíncrono em Java! on whatsapp" href="https://api.whatsapp.com/send?text=5.%20CompletableFuture%20-%20Dominando%20o%20Ass%c3%adncrono%20em%20Java%21%20-%20https%3a%2f%2fkaue.cat%2fposts%2fconcorrencia-java%2fcompletablefuture%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></div></footer><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//www-kaue-cat.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></article></main><footer class=footer><span>&copy; 2024 <a href=https://kaue.cat>Kaue Gatto</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copiar";function s(){t.innerHTML="copiado!",setTimeout(()=>{t.innerHTML="copiar"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>