<!doctype html><html lang=pt dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Features e Refactors Seguros com Java e SPRING: 2 dicas simples! | Kaue Gatto</title><meta name=keywords content="JAVA,SPRING,BACKEND"><meta name=description content="Refactors nem sempre são confortáveis de se fazer, principalmente em pontos ou sistemas críticos, ao mexer nesses pontos, é sempre bom ter um plano B"><meta name=author content="Me"><link rel=canonical href=https://canonical.url/to/page><meta name=google-site-verification content="G-6MZTJBEG75"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.5cfc680b1eeaeef9efbced92d46c2a9e876b72ee14fba85846afc4cff9e6e6f8.css integrity="sha256-XPxoCx7q7vnvvO2S1Gwqnodrcu4U+6hYRq/Ez/nm5vg=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://raw.githubusercontent.com/kauegatto/hugo-PaperMod/6aab706f2e2053433e33f8fd45dbec615f4d479f/images/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://raw.githubusercontent.com/kauegatto/hugo-PaperMod/6aab706f2e2053433e33f8fd45dbec615f4d479f/images/favicon.ico><link rel=icon type=image/png sizes=32x32 href=https://raw.githubusercontent.com/kauegatto/hugo-PaperMod/6aab706f2e2053433e33f8fd45dbec615f4d479f/images/favicon.ico><link rel=apple-touch-icon href=https://raw.githubusercontent.com/kauegatto/hugo-PaperMod/6aab706f2e2053433e33f8fd45dbec615f4d479f/images/favicon.ico><link rel=mask-icon href=https://raw.githubusercontent.com/kauegatto/hugo-PaperMod/6aab706f2e2053433e33f8fd45dbec615f4d479f/images/favicon.ico><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=pt href=https://kaue.cat/posts/refactors_seguros/><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-6MZTJBEG75"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-6MZTJBEG75",{anonymize_ip:!1})}</script><script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","G-6MZTJBEG75","auto"),ga("send","pageview"))</script><script async src=https://www.google-analytics.com/analytics.js></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-6MZTJBEG75"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-6MZTJBEG75",{anonymize_ip:!1})}</script><meta property="og:title" content="Features e Refactors Seguros com Java e SPRING: 2 dicas simples!"><meta property="og:description" content="Refactors nem sempre são confortáveis de se fazer, principalmente em pontos ou sistemas críticos, ao mexer nesses pontos, é sempre bom ter um plano B"><meta property="og:type" content="article"><meta property="og:url" content="https://kaue.cat/posts/refactors_seguros/"><meta property="og:image" content="https://kaue.cat/%3Cimage%20path/url%3E"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-11-12T16:30:03+00:00"><meta property="article:modified_time" content="2023-11-12T16:30:03+00:00"><meta property="og:site_name" content="Kaue Gatto - Blog de Desenvolvimento"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://kaue.cat/%3Cimage%20path/url%3E"><meta name=twitter:title content="Features e Refactors Seguros com Java e SPRING: 2 dicas simples!"><meta name=twitter:description content="Refactors nem sempre são confortáveis de se fazer, principalmente em pontos ou sistemas críticos, ao mexer nesses pontos, é sempre bom ter um plano B"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://kaue.cat/posts/"},{"@type":"ListItem","position":3,"name":"Features e Refactors Seguros com Java e SPRING: 2 dicas simples!","item":"https://kaue.cat/posts/refactors_seguros/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Features e Refactors Seguros com Java e SPRING: 2 dicas simples!","name":"Features e Refactors Seguros com Java e SPRING: 2 dicas simples!","description":"Refactors nem sempre são confortáveis de se fazer, principalmente em pontos ou sistemas críticos, ao mexer nesses pontos, é sempre bom ter um plano B","keywords":["JAVA","SPRING","BACKEND"],"articleBody":"Contexto Quando trabalhando em sistemas reais, temos que nos preocupar com a segurança de nosso código, pontos específicos de nosso código podem ser mais suscetíveis a falhas, mudanças de uma camada de baixo nível (infraestrutura) podem acarretar em problemas caso haja grandes alterações ou até mesmo uma mudança de vendor. Nesse breve artigo irei discutir duas atividades bem frequentes na minha rotina no Bees/AmBev\n1. Features Toggle Em diversos momentos, faz sentido que uma feature seja facilmente desligada ou não usando um toggle, fazendo com que essa alteração não precise de um deploy, dando mais agilidade e segurança à sua alteração. Para isso temos algumas opções, podemos usar variáveis de ambientes ou até mesmo guardar o valor no banco de dados. Uma maneira fácil de implementar em Spring é simplesmente puxar os dados de seu application.properties ou application.yaml\nNo Spring Opção 1: @Value Essa opção é particularmente útil para configurações mais simples, que possuem apenas um campo (ex: Enabled) e não são usadas em diversos lugares. Yaml:\nfeatures: algumaFeature: enabled: true outraFeature: enabled: true Spring:\n@Value(\"${features.algumaFeature.enabled}\") private Boolean valueFromFile; Opção 2: @ConfigurationProperties Melhor para cenários mais complexos, ou quando a propriedade é usada em diversos lugares. Yaml:\nbroker: queues: ticket: name: default.ticket exchanges: ticket: name: direct.ticket type: direct bindings: ticket: exchange: direct.ticket queue: default.ticket routingKey: default.ticke Spring:\n@Configuration @ConfigurationProperties(prefix = \"broker\") @Data public class BrokerConfigurationProperties { private Map\u003cString, QueueProperties\u003e queues; private Map\u003cString, ExchangeProperties\u003e exchanges; private Map\u003cString, BindingProperties\u003e bindings; @Data public static class QueueProperties { @NotEmpty private String name; } @Data public static class ExchangeProperties { @NotEmpty private String name; private String type; } @Data public static class BindingProperties { @NotEmpty private String exchange; @NotEmpty private String queue; @NotEmpty private String routingKey; } } Aqui basta você fazer o mapeamento das classes de acordo com suas propriedades. Se houver dificuldade, é uma tarefa em que alguma AI provavelmente vai lidar com facilidade.\n2. Diferentes Beans de Infraestrutura! Permita um rollback fácil Em um código ideal, a sua camada de domínio provavelmente estará desacoplada de sua camada de infraestrutura por meio de interfaces. Se isso não faz sentido para você, recomendo meu post de SOLID :) Continuando, com um código com módulos de alto e baixo nível desacoplados, conseguimos mudar a infraestrutura sem mexer no domínio. Isso nos dá a liberdade de gerenciar os beans que sua classe de domínio irá usar com mais facilidade, pois todas as implementações de infraestrutura irão respeitar a interface.\n@AllArgsConstructor public class TicketService { private final TicketRepository repository; private final Notifier messagePublisher; public List\u003cTicket\u003e findAll(){ return repository.findAll(); } public Ticket findById(String Id){ return repository.findById(Id).orElseThrow( () -\u003e new TicketNotFoundException(\"Ticket not found\") ); } public Ticket save(Ticket ticket){ messagePublisher.Notify(TicketEventsEnum.TICKET_CREATED); return repository.save(ticket); } } Temos aqui um Simples Service, tendo suas dependências injetadas via construtor pelo SPRING. Note que nosso serviço conhece regras de negócio, dentre elas, quando um ticket é criado, ele tem que notificar algo, e tem que guardar em algum lugar (repository pode cuidar de mongoDB, MySQL, et cetera.) Note que se tivermos um repositório com código específico do MySQL e quisermos migrar para um código com Spring Data JPA, teremos que mudar a camada de infraestrutura (resumidamente, vamos escrever mais código de Repositório), mas nossa regra de negócio é a mesma. Imagine agora que essa camada é um ponto crítico da sua aplicação, caso a implementação que você fez com tanta boa vontade dê errado, você terá que fazer um rollback.\nDefinindo os Beans Manualmente Ao invés de definir os repositórios com @Component, como teremos dois repositórios, o Spring não saberá com qual Bean lidar. Temos diversas maneiras de fazer a desambiguação de Beans, dentre elas, prioridades, primary, qualifier, aqui vou para uma abordagem simples, apenas para exemplificar a feature. No meu yaml, irei definir uma propriedade:\nrepository: type: ${DEFINED_REPOSITORY:mysql} Caso exista uma variável de ambiente chamada DEFINED_REPOSITORY, ela será o padrão para o tipo do meu repositório, caso contrário, será mysql, como um fallback. (No caso, escolhi deixar o MySQL como fallback pois teoricamente ele é o repositório testado e já em produção). Perfeito, agora vamos definir qual bean utilizar:\n@Configuration public class RepositoryConfiguration{ @Value(\"${repository.type}\") private String repositoryType; @Bean public TicketRepository ticketRepository (){ if(\"mysql\".equalsIgnoreCase(repositoryType)){ return new MySQLTicketRepository(); } if(\"spring\".equalsIgnoreCase(repositoryType)){ return new JpaTicketRepository(); } return new MySQLTicketRepository(); // fallback } } Outra maneira de fazer esse tipo de configuração é usar profiles do Spring.\nObrigado! Obrigado, espero que o breve artigo tenha sido útil. Escrevi em 20 minutos e não o revisei, então se houver algum problema, pode me avisar :)\n","wordCount":"746","inLanguage":"pt","image":"https://kaue.cat/%3Cimage%20path/url%3E","datePublished":"2023-11-12T16:30:03Z","dateModified":"2023-11-12T16:30:03Z","author":{"@type":"Person","name":"Me"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://kaue.cat/posts/refactors_seguros/"},"publisher":{"@type":"Organization","name":"Kaue Gatto","logo":{"@type":"ImageObject","url":"https://raw.githubusercontent.com/kauegatto/hugo-PaperMod/6aab706f2e2053433e33f8fd45dbec615f4d479f/images/favicon.ico"}}}</script></head><body class=dark id=top><script>localStorage.getItem("pref-theme")==="light"&&document.body.classList.remove("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://kaue.cat accesskey=h title="Home (Alt + H)"><img src=https://kaue.cat/apple-touch-icon.png alt aria-label=logo height=35>Home</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li>|</li><li><a href=https://kaue.cat/en/ title=English aria-label=English>En</a></li></ul></div></div><ul id=menu><li><a href=https://kaue.cat/archives title=Arquivo><span>Arquivo</span></a></li><li><a href=https://kaue.cat/search/ title=Buscar><span>Buscar</span></a></li><li><a href=https://kaue.cat/series/ title=Séries><span>Séries</span></a></li><li><a href=https://kaue.cat/tags/ title=Tags><span>Tags</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://kaue.cat>Início</a>&nbsp;»&nbsp;<a href=https://kaue.cat/posts/>Posts</a></div><h1 class=post-title>Features e Refactors Seguros com Java e SPRING: 2 dicas simples!</h1><div class=post-description>Refactors nem sempre são confortáveis de se fazer, principalmente em pontos ou sistemas críticos, ao mexer nesses pontos, é sempre bom ter um plano B</div><div class=post-meta><span title='2023-11-12 16:30:03 +0000 UTC'>12 de novembro , 2023</span>&nbsp;·&nbsp;4 minutos&nbsp;·&nbsp;746 palavras&nbsp;·&nbsp;Me&nbsp;|&nbsp;<a href=https://github.com/kauegatto/kauedotcat/content/posts/refactors_seguros.md rel="noopener noreferrer" target=_blank>Sugerir Alterações</a></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Conteúdo</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#1-features-toggle>1. Features Toggle</a><ul><li><a href=#no-spring>No Spring</a></li></ul></li><li><a href=#2-diferentes-beans-de-infraestrutura-permita-um-rollback-fácil>2. Diferentes Beans de Infraestrutura! Permita um rollback fácil</a><ul><li><a href=#definindo-os-beans-manualmente>Definindo os Beans Manualmente</a></li></ul></li></ul></nav></div></details></div><div class=post-content><h1 id=contexto>Contexto<a hidden class=anchor aria-hidden=true href=#contexto>#</a></h1><p>Quando trabalhando em sistemas reais, temos que nos preocupar com a segurança de nosso código, pontos específicos de nosso código podem ser mais suscetíveis a falhas, mudanças de uma camada de baixo nível (infraestrutura) podem acarretar em problemas caso haja grandes alterações ou até mesmo uma mudança de vendor. Nesse breve artigo irei discutir duas atividades bem frequentes na minha rotina no Bees/AmBev</p><h2 id=1-features-toggle>1. Features Toggle<a hidden class=anchor aria-hidden=true href=#1-features-toggle>#</a></h2><p>Em diversos momentos, faz sentido que uma feature seja facilmente desligada ou não usando um toggle, fazendo com que essa alteração não precise de um deploy, dando mais agilidade e segurança à sua alteração.
Para isso temos algumas opções, podemos usar variáveis de ambientes ou até mesmo guardar o valor no banco de dados.
Uma maneira fácil de implementar em Spring é simplesmente puxar os dados de seu<code> application.properties</code> ou <code>application.yaml</code></p><h3 id=no-spring>No Spring<a hidden class=anchor aria-hidden=true href=#no-spring>#</a></h3><h4 id=opção-1-value>Opção 1: @Value<a hidden class=anchor aria-hidden=true href=#opção-1-value>#</a></h4><p>Essa opção é particularmente útil para configurações mais simples, que possuem apenas um campo (ex: Enabled) e não são usadas em diversos lugares.
Yaml:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>features</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>algumaFeature</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>enabled</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>outraFeature</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>enabled</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span></code></pre></div><p>Spring:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Value</span><span class=o>(</span><span class=s>&#34;${features.algumaFeature.enabled}&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=kd>private</span> <span class=n>Boolean</span> <span class=n>valueFromFile</span><span class=o>;</span>
</span></span></code></pre></div><h4 id=opção-2-configurationproperties>Opção 2: @ConfigurationProperties<a hidden class=anchor aria-hidden=true href=#opção-2-configurationproperties>#</a></h4><p>Melhor para cenários mais complexos, ou quando a propriedade é usada em diversos lugares.
Yaml:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>broker</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>queues</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>ticket</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>default.ticket</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>exchanges</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>ticket</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>direct.ticket</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>direct</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>bindings</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>ticket</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>exchange</span><span class=p>:</span><span class=w> </span><span class=l>direct.ticket</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>queue</span><span class=p>:</span><span class=w> </span><span class=l>default.ticket</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>routingKey</span><span class=p>:</span><span class=w> </span><span class=l>default.ticke</span><span class=w>
</span></span></span></code></pre></div><p>Spring:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Configuration</span>
</span></span><span class=line><span class=cl><span class=nd>@ConfigurationProperties</span><span class=o>(</span><span class=n>prefix</span> <span class=o>=</span> <span class=s>&#34;broker&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=nd>@Data</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>BrokerConfigurationProperties</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=o>,</span> <span class=n>QueueProperties</span><span class=o>&gt;</span> <span class=n>queues</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=o>,</span> <span class=n>ExchangeProperties</span><span class=o>&gt;</span> <span class=n>exchanges</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=o>,</span> <span class=n>BindingProperties</span><span class=o>&gt;</span> <span class=n>bindings</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Data</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kd>static</span> <span class=kd>class</span> <span class=nc>QueueProperties</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=nd>@NotEmpty</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>String</span> <span class=n>name</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Data</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kd>static</span> <span class=kd>class</span> <span class=nc>ExchangeProperties</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=nd>@NotEmpty</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>String</span> <span class=n>name</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>String</span> <span class=n>type</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Data</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kd>static</span> <span class=kd>class</span> <span class=nc>BindingProperties</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=nd>@NotEmpty</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>String</span> <span class=n>exchange</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=nd>@NotEmpty</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>String</span> <span class=n>queue</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=nd>@NotEmpty</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>String</span> <span class=n>routingKey</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>Aqui basta você fazer o mapeamento das classes de acordo com suas propriedades. Se houver dificuldade, é uma tarefa em que alguma AI provavelmente vai lidar com facilidade.</p><h2 id=2-diferentes-beans-de-infraestrutura-permita-um-rollback-fácil>2. Diferentes Beans de Infraestrutura! Permita um rollback fácil<a hidden class=anchor aria-hidden=true href=#2-diferentes-beans-de-infraestrutura-permita-um-rollback-fácil>#</a></h2><p>Em um código ideal, a sua camada de domínio provavelmente estará desacoplada de sua camada de infraestrutura por meio de interfaces. Se isso não faz sentido para você, recomendo meu post de SOLID :)
Continuando, com um código com módulos de alto e baixo nível desacoplados, conseguimos mudar a infraestrutura sem mexer no domínio. Isso nos dá a liberdade de gerenciar os beans que sua classe de domínio irá usar com mais facilidade, pois todas as implementações de infraestrutura irão respeitar a interface.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@AllArgsConstructor</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>TicketService</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kd>final</span> <span class=n>TicketRepository</span> <span class=n>repository</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kd>final</span> <span class=n>Notifier</span> <span class=n>messagePublisher</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=n>List</span><span class=o>&lt;</span><span class=n>Ticket</span><span class=o>&gt;</span> <span class=nf>findAll</span><span class=o>(){</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>repository</span><span class=o>.</span><span class=na>findAll</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=n>Ticket</span> <span class=nf>findById</span><span class=o>(</span><span class=n>String</span> <span class=n>Id</span><span class=o>){</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>repository</span><span class=o>.</span><span class=na>findById</span><span class=o>(</span><span class=n>Id</span><span class=o>).</span><span class=na>orElseThrow</span><span class=o>(</span>
</span></span><span class=line><span class=cl>            <span class=o>()</span> <span class=o>-&gt;</span> <span class=k>new</span> <span class=n>TicketNotFoundException</span><span class=o>(</span><span class=s>&#34;Ticket not found&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=n>Ticket</span> <span class=nf>save</span><span class=o>(</span><span class=n>Ticket</span> <span class=n>ticket</span><span class=o>){</span>
</span></span><span class=line><span class=cl>    <span class=n>messagePublisher</span><span class=o>.</span><span class=na>Notify</span><span class=o>(</span><span class=n>TicketEventsEnum</span><span class=o>.</span><span class=na>TICKET_CREATED</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>repository</span><span class=o>.</span><span class=na>save</span><span class=o>(</span><span class=n>ticket</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>Temos aqui um Simples Service, tendo suas dependências injetadas via construtor pelo SPRING. Note que nosso serviço conhece regras de negócio, dentre elas, quando um ticket é criado, ele tem que notificar algo, e tem que guardar em algum lugar (repository pode cuidar de mongoDB, MySQL, et cetera.)
Note que se tivermos um repositório com código específico do MySQL e quisermos migrar para um código com Spring Data JPA, teremos que mudar a camada de infraestrutura (resumidamente, vamos escrever mais código de Repositório), mas nossa regra de negócio é a mesma.
Imagine agora que essa camada é um ponto crítico da sua aplicação, caso a implementação que você fez com tanta boa vontade dê errado, você terá que fazer um rollback.</p><h3 id=definindo-os-beans-manualmente>Definindo os Beans Manualmente<a hidden class=anchor aria-hidden=true href=#definindo-os-beans-manualmente>#</a></h3><p>Ao invés de definir os repositórios com <code>@Component</code>, como teremos dois repositórios, o Spring não saberá com qual Bean lidar.
Temos diversas maneiras de fazer a desambiguação de Beans, dentre elas, prioridades, primary, qualifier, aqui vou para uma abordagem simples, apenas para exemplificar a feature.
No meu yaml, irei definir uma propriedade:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>repository</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>${DEFINED_REPOSITORY:mysql}</span><span class=w>
</span></span></span></code></pre></div><p>Caso exista uma variável de ambiente chamada DEFINED_REPOSITORY, ela será o padrão para o tipo do meu repositório, caso contrário, será mysql, como um fallback. (No caso, escolhi deixar o MySQL como fallback pois teoricamente ele é o repositório testado e já em produção).
Perfeito, agora vamos definir qual bean utilizar:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Configuration</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>RepositoryConfiguration</span><span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Value</span><span class=o>(</span><span class=s>&#34;${repository.type}&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=n>String</span> <span class=n>repositoryType</span><span class=o>;</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>  <span class=nd>@Bean</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=n>TicketRepository</span> <span class=nf>ticketRepository</span> <span class=o>(){</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=o>(</span><span class=s>&#34;mysql&#34;</span><span class=o>.</span><span class=na>equalsIgnoreCase</span><span class=o>(</span><span class=n>repositoryType</span><span class=o>)){</span>
</span></span><span class=line><span class=cl>       <span class=k>return</span> <span class=k>new</span> <span class=n>MySQLTicketRepository</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=o>(</span><span class=s>&#34;spring&#34;</span><span class=o>.</span><span class=na>equalsIgnoreCase</span><span class=o>(</span><span class=n>repositoryType</span><span class=o>)){</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=k>new</span> <span class=n>JpaTicketRepository</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=k>new</span> <span class=n>MySQLTicketRepository</span><span class=o>();</span> <span class=c1>// fallback
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>Outra maneira de fazer esse tipo de configuração é usar profiles do Spring.</p><h1 id=obrigado>Obrigado!<a hidden class=anchor aria-hidden=true href=#obrigado>#</a></h1><p>Obrigado, espero que o breve artigo tenha sido útil. Escrevi em 20 minutos e não o revisei, então se houver algum problema, pode me avisar :)</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://kaue.cat/tags/java/>JAVA</a></li><li><a href=https://kaue.cat/tags/spring/>SPRING</a></li><li><a href=https://kaue.cat/tags/backend/>BACKEND</a></li></ul><nav class=paginav><a class=prev href=https://kaue.cat/posts/encapsulamento/><span class=title>« Página Anterior</span><br><span>Encapsulamento: O Básico que todo jr. precisa saber!</span></a></nav><div class=share-buttons><a>Compartilhar:</a><br><a target=_blank rel="noopener noreferrer" aria-label="share Features e Refactors Seguros com Java e SPRING: 2 dicas simples! on x" href="https://x.com/intent/tweet/?text=Features%20e%20Refactors%20Seguros%20com%20Java%20e%20SPRING%3a%202%20dicas%20simples%21&url=https%3a%2f%2fkaue.cat%2fposts%2frefactors_seguros%2f&hashtags=JAVA%2cSPRING%2cBACKEND"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Features e Refactors Seguros com Java e SPRING: 2 dicas simples! on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fkaue.cat%2fposts%2frefactors_seguros%2f&title=Features%20e%20Refactors%20Seguros%20com%20Java%20e%20SPRING%3a%202%20dicas%20simples%21&summary=Features%20e%20Refactors%20Seguros%20com%20Java%20e%20SPRING%3a%202%20dicas%20simples%21&source=https%3a%2f%2fkaue.cat%2fposts%2frefactors_seguros%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Features e Refactors Seguros com Java e SPRING: 2 dicas simples! on whatsapp" href="https://api.whatsapp.com/send?text=Features%20e%20Refactors%20Seguros%20com%20Java%20e%20SPRING%3a%202%20dicas%20simples%21%20-%20https%3a%2f%2fkaue.cat%2fposts%2frefactors_seguros%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></div></footer><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//www-kaue-cat.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></article></main><footer class=footer><span>&copy; 2025 <a href=https://kaue.cat>Kaue Gatto</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copiar";function s(){t.innerHTML="copiado!",setTimeout(()=>{t.innerHTML="copiar"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>